C  ***** PEER NGA-West 2 MODELS Vertical (2013) **********



c ---------------------------------------------------------------------------            
C     *** Stewart, Boore, Seyhan and Atkinson NGA West 2 (NGA West2-2013) ***
C         Earthquake Spectra Report:
C            NGA-West2 Equations for Predicting Vertical-Component PGA, PGV,
C            and 5%-Damped PSA from Shallow Crustal Earthquakes
C          Earthquake Spectra
C     Notes:
C        Applicable Range:
C            3.0 < M < 8.5 (Strike-Slip)
C            3.0 < M < 7.0 (Normal)
C            Distance < 300km
C            150 < Vs < 1500 m/s
C            Region Flag:
C               0 = Global 
C               1 = China-Turkey
C               2 = Italy-Japan
C      Note that for this vertical model the basin term and depth to Z10 term is not
C          used. However, these parameters are still passed to this subroutine to be
C          consistent on with the horizontal version of this GMPE model. Also note that
C          'Unknown' mechanism case is not coded since for any PSHA seismic source model
C          a specific mechanism must be assigned.
c ---------------------------------------------------------------------------            

      subroutine SSBA_NGAWest2_2013_Vert ( mag, Rbjf, specT, 
     1        period2, lnY, sigma, iflag, vs, ftype, pga4nl, z10, regionflag, basinflag, phi, tau ) 

C     Last Updated: 12/07/15

      implicit none
   
      integer MAXPER, i, nPer
      parameter (MAXPER=107)
      REAL Period(MAXPER), c1(MAXPER), c2(MAXPER), c3(MAXPER)
      real h(MAXPER), DC3ChinaTrk(MAXPER), DC3ItalyJapan(MAXPER), e0(MAXPER)
      real e1(MAXPER), e2(MAXPER), e3(MAXPER), e4(MAXPER)
      real e5(MAXPER), e6(MAXPER), mh(MAXPER), Vc(MAXPER)
      real f4(MAXPER), f5(MAXPER), DC3Global(MAXPER), cv(MAXPER)
      real phi1(MAXPER), phi2(MAXPER), tau1(MAXPER), tau2(MAXPER)

      real Mref, Rref, Vref, f1, f3, specT, sigma
      REAL MAG, RBJF, VS, Z10, phi2T, tau2T
      real ftype, Rp, R, period2, period1, term1, term2, term3
      INTEGER iFlag, count1, count2, regionflag, basinflag
      real lnY, mechS, mechN, mechR, pga4nl
      real f2, flin
      real c1T, c2T, c3T, hT, e0T, e1T, e2T, e3T, e4T
      real e5T, e6T, mhT, VcT, f4T, f5T, DC3GlobalT
      real DC3ChinaTrkT, DC3ItalyJapanT
      real cvT, phi1T, tau1T, Phi, Tau

      data  period  / 0.0, -1.0, 0.01, 0.02, 0.022, 0.025, 0.029, 0.03, 0.032, 0.035, 0.036, 0.04, 
     1                0.042, 0.044, 0.045, 0.046, 0.048, 0.05, 0.055, 0.06, 0.065, 0.067, 0.07, 0.075,
     1                0.08, 0.085, 0.09, 0.095, 0.1, 0.11, 0.12, 0.13, 0.133, 0.14, 0.15, 0.16, 0.17,
     1                0.18, 0.19, 0.2, 0.22, 0.24, 0.25, 0.26, 0.28, 0.29, 0.3, 0.32, 0.34, 0.35, 0.36, 0.38,
     1                0.4, 0.42, 0.44, 0.45, 0.46, 0.48, 0.5, 0.55, 0.6, 0.65, 0.667, 0.7, 0.75, 0.8, 0.85,
     1                0.9, 0.95, 1, 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7, 1.8, 1.9, 2, 2.2, 2.4, 2.5, 2.6,
     1                2.8, 3, 3.2, 3.4, 3.5, 3.6, 3.8, 4, 4.2, 4.4, 4.6, 4.8, 5, 5.5, 6, 6.5, 7, 7.5, 8,
     1                8.5, 9, 9.5, 10  / 
      data  e0  / 0.1836, 4.267, 0.2045, 0.3937, 0.4449, 0.5313, 0.6464, 0.6712, 0.7158, 0.7728, 0.7888,
     1            0.8367, 0.8531, 0.8651, 0.8694, 0.8734, 0.8807, 0.8864, 0.8922, 0.8855, 0.875, 0.8716,
     1            0.8671, 0.8598, 0.853, 0.849, 0.8473, 0.8474, 0.8487, 0.8498, 0.8403, 0.8232, 0.8162, 
     1            0.7948, 0.7554, 0.7109, 0.6624, 0.6125, 0.563, 0.5165, 0.4312, 0.3537, 0.3192, 0.2865,
     1            0.2272, 0.1998, 0.1731, 0.1243, 0.0759, 0.05184, 0.02853, -0.01612, -0.05769, -0.0972,
     1           -0.1354, -0.1543, -0.1728, -0.2085, -0.2404, -0.3137, -0.3728, -0.4197, -0.4339, -0.459,
     1           -0.4912, -0.5171, -0.5407, -0.5614, -0.5793, -0.5953, -0.6232, -0.6488, -0.6788, -0.713,
     1           -0.7504, -0.7889, -0.8284, -0.8689, -0.91, -0.953, -1.044, -1.138, -1.186, -1.238, -1.349,
     1           -1.463, -1.581, -1.689, -1.74, -1.792, -1.894, -1.999, -2.103, -2.203, -2.305, -2.407, -2.512,
     1           -2.776, -3.053, -3.325, -3.586, -3.835, -4.068, -4.292, -4.5, -4.689, -4.87  / 
      data  e1  / 0.2337, 4.292, 0.2553, 0.4468, 0.499, 0.5877, 0.7061, 0.7315, 0.7774, 0.8359, 0.8525, 0.9021,
     1            0.9189, 0.9316, 0.9362, 0.9406, 0.9488, 0.9551, 0.9624, 0.9568, 0.9468, 0.9433, 0.9384, 
     1            0.9301, 0.9221, 0.917, 0.9146, 0.9138, 0.9141, 0.9129, 0.9007, 0.8804, 0.8723, 0.8478, 0.8037,
     1            0.7548, 0.7019, 0.6478, 0.5943, 0.5443, 0.4527, 0.3703, 0.3336, 0.2988, 0.2364, 0.2079, 0.1806,
     1            0.1307, 0.08191, 0.05787, 0.03466, -0.009451, -0.0504, -0.08928, -0.127, -0.1458, -0.1642, -0.1998,
     1           -0.2318, -0.3056, -0.3652, -0.4126, -0.4269, -0.4524, -0.4851, -0.5117, -0.5357, -0.557, 
     1           -0.5754, -0.5918, -0.6198, -0.6458, -0.6757, -0.71, -0.7472, -0.7864, -0.827, -0.8685, -0.9099,
     1           -0.9542, -1.05, -1.154, -1.206, -1.261, -1.377, -1.496, -1.619, -1.731, -1.784, -1.836, 
     1           -1.937, -2.039, -2.141, -2.241, -2.344, -2.45, -2.558, -2.831, -3.12, -3.406, -3.678, -3.936,
     1           -4.175, -4.402, -4.609, -4.8, -4.989  / 
      data  e2  / 0.01562, 4.179, 0.0351, 0.2295, 0.2805, 0.3665, 0.4857, 0.512, 0.5603, 0.6229, 0.6411,
     1            0.6945, 0.7112, 0.7223, 0.7255, 0.7284, 0.7328, 0.7354, 0.7315, 0.7102, 0.6839, 0.6746,
     1            0.6615, 0.6421, 0.6272, 0.6155, 0.6072, 0.6027, 0.6011, 0.5996, 0.5925, 0.5827, 0.5783,
     1            0.5634, 0.5335, 0.4992, 0.4631, 0.4263, 0.3894, 0.3544, 0.2841, 0.2156, 0.1844, 0.1538, 
     1            0.09515, 0.06725, 0.03965, -0.01177, -0.06254, -0.08772, -0.112, -0.1588, -0.2022, -0.2424,
     1           -0.2798, -0.2974, -0.3146, -0.347, -0.3755, -0.4415, -0.4969, -0.5387, -0.5514, -0.5746, -0.6053,
     1           -0.6308, -0.6545, -0.6752, -0.6926, -0.7082, -0.7376, -0.7635, -0.7923, -0.8223, -0.8534, -0.8839,
     1           -0.9098, -0.9344, -0.9606, -0.9889, -1.041, -1.094, -1.125, -1.161, -1.241, -1.33, -1.425, -1.509,
     1           -1.553, -1.601, -1.7, -1.806, -1.91, -2.011, -2.109, -2.206, -2.306, -2.564, -2.836, -3.103, 
     1           -3.373, -3.636, -3.894, -4.142, -4.392, -4.605, -4.795  / 
      data  e3  / 0.1538, 4.255, 0.1741, 0.3568, 0.4062, 0.4881, 0.5954, 0.6182, 0.6589, 0.7104, 0.7248,
     1            0.7672, 0.7822, 0.7936, 0.7976, 0.8014, 0.8084, 0.814, 0.8208, 0.8176, 0.8127, 0.8119,
     1            0.8115, 0.8108, 0.8098, 0.8108, 0.8133, 0.8168, 0.8212, 0.828, 0.8224, 0.8088, 0.8031,
     1            0.7851, 0.7509, 0.7107, 0.6658, 0.6189, 0.5717, 0.5274, 0.4482, 0.3766, 0.3453, 0.3158,
     1            0.262, 0.2369, 0.2121, 0.1665, 0.1197, 0.09601, 0.07287, 0.02804, -0.01392, -0.05441, 
     1           -0.09389, -0.1135, -0.1327, -0.1699, -0.2027, -0.278, -0.3378, -0.3858, -0.4004, -0.4259,
     1           -0.4575, -0.482, -0.5046, -0.5245, -0.5416, -0.5571, -0.5839, -0.6086, -0.6394, -0.6751,
     1           -0.7152, -0.7558, -0.7985, -0.8435, -0.8901, -0.9363, -1.032, -1.126, -1.173, -1.225,
     1           -1.336, -1.453, -1.569, -1.677, -1.73, -1.782, -1.89, -1.999, -2.106, -2.208, -2.309, 
     1           -2.408, -2.506, -2.753, -3.01, -3.256, -3.493, -3.72, -3.932, -4.137, -4.33, -4.509, -4.668  / 
      data  e4  / 1.247, 0.9925, 1.242, 1.243, 1.24, 1.232, 1.22, 1.217, 1.215, 1.212, 1.212, 1.215, 1.219, 
     1            1.223, 1.225, 1.228, 1.233, 1.24, 1.257, 1.276, 1.297, 1.306, 1.32, 1.345, 1.367, 1.386, 
     1            1.402, 1.414, 1.425, 1.44, 1.438, 1.419, 1.412, 1.391, 1.354, 1.311, 1.263, 1.211, 1.159,
     1            1.11, 1.025, 0.9546, 0.9253, 0.8998, 0.861, 0.8466, 0.8355, 0.8205, 0.8109, 0.8077, 0.8056,
     1            0.8049, 0.8094, 0.8187, 0.8296, 0.8351, 0.8406, 0.852, 0.8653, 0.903, 0.9475, 0.9958, 1.012,
     1            1.043, 1.09, 1.137, 1.183, 1.228, 1.274, 1.32, 1.411, 1.497, 1.574, 1.641, 1.698, 1.752, 1.801,
     1            1.847, 1.893, 1.934, 2.017, 2.097, 2.131, 2.161, 2.217, 2.268, 2.303, 2.333, 2.347, 2.361,
     1            2.385, 2.413, 2.438, 2.462, 2.476, 2.483, 2.488, 2.496, 2.492, 2.467, 2.426, 2.384, 2.344,
     1            2.308, 2.258, 2.221, 2.187  / 
      data  e5  / 0.0, -0.1114, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
     1            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.00006245, -0.003053,
     1           -0.01037, -0.013, -0.02022, -0.03283, -0.04732, -0.06364, -0.08103, -0.09818, -0.1139, 
     1           -0.1423, -0.1668, -0.1776, -0.1873, -0.2027, -0.209, -0.2147, -0.2243, -0.2322, -0.2356,
     1           -0.2388, -0.244, -0.2478, -0.2501, -0.252, -0.2528, -0.2536, -0.2549, -0.2555, -0.2558,
     1           -0.2529, -0.2477, -0.2458, -0.2421, -0.2362, -0.2301, -0.224, -0.2176, -0.2111, -0.2046,
     1           -0.1919, -0.1803, -0.1707, -0.1633, -0.1576, -0.1513, -0.145, -0.1388, -0.1321, -0.1265,
     1           -0.1124, -0.09569, -0.08824, -0.0818, -0.06882, -0.0568, -0.0487, -0.03988, -0.03594, 
     1           -0.03238, -0.02602, -0.02068, -0.01549, -0.01109, -0.008411, -0.007098, -0.005876, -0.001251,
     1           -0.0000625, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  / 
      data  e6  / 0.02257, 0.247, 0.0222, 0.01038, 0.008442, 0.006672, 0.007363, 0.008618, 0.01271, 0.02086,
     1            0.02399, 0.03692, 0.04466, 0.05266, 0.05705, 0.06155, 0.0713, 0.08106, 0.1039, 0.1232, 
     1            0.142, 0.1488, 0.1579, 0.1697, 0.1757, 0.174, 0.1674, 0.1574, 0.1444, 0.1096, 0.07126,
     1            0.03143, 0.02029, -0.002279, -0.02798, -0.04711, -0.06097, -0.07071, -0.07737, -0.08194,
     1           -0.08635, -0.08649, -0.08578, -0.08565, -0.08606, -0.08551, -0.0841, -0.08361, -0.08305, 
     1           -0.08273, -0.08213, -0.08062, -0.07807, -0.07506, -0.07102, -0.06892, -0.06703, -0.06427,
     1           -0.06214, -0.05023, -0.0364, -0.02521, -0.02075, -0.01147, 0.002752, 0.01987, 0.03944,
     1            0.06023, 0.08275, 0.1069, 0.1546, 0.1994, 0.253, 0.3049, 0.3538, 0.3984, 0.4415, 0.4845,
     1            0.5263, 0.5663, 0.6359, 0.7011, 0.7325, 0.7635, 0.8242, 0.8836, 0.9382, 0.9819, 1.001, 
     1            1.02, 1.055, 1.088, 1.116, 1.142, 1.164, 1.181, 1.192, 1.204, 1.206, 1.194, 1.177, 1.162,
     1            1.152, 1.138, 1.142, 1.158, 1.158  / 
      data  mh  / 5.5, 6.2, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5,
     1            5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.5, 5.51, 5.52, 5.53, 5.54, 5.57, 5.62, 5.66, 
     1            5.67, 5.7, 5.74, 5.78, 5.82, 5.85, 5.89, 5.92, 5.97, 6.03, 6.05, 6.07, 6.11, 6.12,
     1            6.14, 6.16, 6.18, 6.18, 6.19, 6.19, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2,
     1            6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 
     1            6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2,
     1            6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2, 6.2  / 
      data  c1  / -1.175, -1.254, -1.176, -1.212, -1.221, -1.233, -1.243, -1.245, -1.246, -1.244, -1.243,
     1            -1.232, -1.226, -1.218, -1.214, -1.21, -1.201, -1.193, -1.17, -1.147, -1.126, -1.118, 
     1            -1.107, -1.091, -1.076, -1.064, -1.054, -1.047, -1.04, -1.028, -1.017, -1.01, -1.008, 
     1            -1.003, -0.996, -0.9901, -0.9855, -0.9818, -0.979, -0.9772, -0.9736, -0.9703, -0.969, 
     1            -0.9682, -0.9672, -0.9668, -0.9665, -0.9663, -0.9667, -0.9672, -0.968, -0.9701, -0.9728, 
     1            -0.9754, -0.978, -0.9792, -0.9805, -0.9834, -0.9867, -0.9947, -1.005, -1.015, -1.018, 
     1            -1.026, -1.037, -1.048, -1.06, -1.071, -1.08, -1.089, -1.104, -1.116, -1.126, -1.136, 
     1            -1.144, -1.152, -1.16, -1.168, -1.173, -1.177, -1.181, -1.182, -1.182, -1.181, -1.176,
     1            -1.168, -1.16, -1.156, -1.154, -1.151, -1.144, -1.133, -1.121, -1.11, -1.101, -1.092,
     1            -1.085, -1.065, -1.043, -1.03, -1.024, -1.019, -1.016, -1.012, -1.013, -1.013, -1.015  / 
      data  c2  / 0.1577, 0.1715, 0.1573, 0.1598, 0.1603, 0.1608, 0.1611, 0.1608, 0.1601, 0.1584, 0.1576,
     1            0.1544, 0.1523, 0.1501, 0.1488, 0.1475, 0.1448, 0.142, 0.1348, 0.1285, 0.1224, 0.12,
     1            0.1166, 0.1115, 0.1077, 0.1052, 0.1038, 0.1029, 0.1023, 0.1024, 0.1042, 0.107, 0.1079,
     1            0.1099, 0.1126, 0.1152, 0.1175, 0.1199, 0.1221, 0.1241, 0.1267, 0.1287, 0.1292, 0.1298,
     1            0.1309, 0.1313, 0.1316, 0.132, 0.1328, 0.1332, 0.1337, 0.1344, 0.135, 0.1356, 0.1361,
     1            0.1365, 0.1368, 0.1377, 0.1384, 0.139, 0.1389, 0.1388, 0.1387, 0.1384, 0.1377, 0.1365,
     1            0.1351, 0.1335, 0.1316, 0.1292, 0.1236, 0.1173, 0.1102, 0.1036, 0.09771, 0.09237, 0.08763,
     1            0.08328, 0.07913, 0.07495, 0.0682, 0.06271, 0.06053, 0.05888, 0.05573, 0.05261, 0.05069,
     1            0.05061, 0.05071, 0.05057, 0.05008, 0.04875, 0.04764, 0.04681, 0.04689, 0.04803, 0.05014,
     1            0.05798, 0.06732, 0.08082, 0.09668, 0.1116, 0.1247, 0.1377, 0.1502, 0.1579, 0.1601  / 
      data  c3  / -0.009222, -0.0034, -0.009222, -0.009039, -0.009038, -0.009071, -0.0092085, -0.0092595,
     1            -0.0093885, -0.009629, -0.0097195, -0.01012, -0.01034, -0.01055, -0.01066, -0.01077, 
     1            -0.01097, -0.01116, -0.01157, -0.01187, -0.01207, -0.01213, -0.01218, -0.01222, -0.01218,
     1            -0.01208, -0.011965, -0.011835, -0.01169, -0.01137, -0.011055, -0.010725, -0.01062, -0.0104,
     1            -0.010125, -0.009805, -0.009505, -0.00922, -0.0089545, -0.0087095, -0.008254, -0.0078455,
     1            -0.007662, -0.0074815, -0.0071495, -0.0069925, -0.006843, -0.006556, -0.0062865, -0.006157,
     1            -0.0060295, -0.0057885, -0.0055585, -0.0053435, -0.005138, -0.005042, -0.004947, 
     1            -0.0047645, -0.004596, -0.0042055, -0.003867, -0.003578, -0.00349, -0.003326, -0.0031095,
     1            -0.0029225, -0.002758, -0.002616, -0.002485, -0.00236, -0.002185, -0.00203, -0.001875,
     1            -0.001745, -0.00162, -0.00152, -0.001415, -0.00134, -0.001265, -0.00119, -0.001088,
     1            -0.000991, -0.000948, -0.0009, -0.0008095, -0.000704, -0.0006385, -0.0005769, 
     1            -0.0005474, -0.0005188, -0.0004639, -0.0004118, -0.0003623, -0.000315, -0.0002699,
     1            -0.0002266, -0.0001852, -0.00008837, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  / 
      data Dc3Global  /  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
     1    0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
     1    0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
     1    0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
     1    0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
     1    0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  / 
      data  Dc3ChinaTrk  / 0.00475, 0.00336, 0.00498, 0.005207, 0.005251, 0.005316, 0.0054, 0.00542, 
     1                     0.00546, 0.005518, 0.005536, 0.005603, 0.005633, 0.005658, 0.00567, 0.00568, 0.005697, 0.00571,
     1                     0.00572, 0.005702, 0.005662, 0.00564, 0.005604, 0.005534, 0.005457, 0.005378, 0.005302, 
     1                     0.005234, 0.00518, 0.005121, 0.005117, 0.005148, 0.005162, 0.005196, 0.00524, 0.005266, 0.005271,
     1                     0.005257, 0.005227, 0.005181, 0.00505, 0.004878, 0.004781, 0.004678, 0.004464, 0.004356, 0.00425,
     1                     0.004046, 0.003855, 0.003764, 0.003676, 0.003509, 0.003354, 0.003209, 0.003075, 0.003013, 0.002952,
     1                     0.002839, 0.002735, 0.002515, 0.002347, 0.002225, 0.002193, 0.002143, 0.002096, 0.002077, 0.002081,
     1                     0.002102, 0.002133, 0.00217, 0.002243, 0.002314, 0.002382, 0.002446, 0.002506, 0.002563, 0.002617,
     1                     0.002666, 0.002711, 0.002751, 0.002818, 0.002865, 0.00288, 0.00289, 0.002892, 0.00287, 0.002822,
     1                     0.002752, 0.00271, 0.002663, 0.002559, 0.002443, 0.002318, 0.002189, 0.002059, 0.001931, 0.00181,
     1                     0.001546, 0.001337, 0.001176, 0.001057, 0.0009748, 0.0009228, 0.0008949, 0.0008852, 0.0008876,
     1                     0.000896  / 
      data  Dc3ItalyJapan  / 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
     1                       0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.0001, -0.00025, -0.00045, -0.00065,
     1                      -0.00085, -0.0009, -0.0011, -0.00132, -0.00152, -0.00168, -0.00183, -0.00195, -0.00205,
     1                      -0.0022, -0.0023, -0.00233, -0.00235, -0.00237, -0.00237, -0.00237, -0.00237, -0.00237,
     1                      -0.00237, -0.00236, -0.00236, -0.00235, -0.00234, -0.00232, -0.00232, -0.00231, -0.00229,
     1                      -0.00228, -0.00223, -0.00217, -0.00211, -0.00208, -0.00204, -0.00196, -0.00189, -0.00181,
     1                      -0.00173, -0.00165, -0.00158, -0.00143, -0.0013, -0.00118, -0.00107, -0.000974, -0.000886,
     1                      -0.000807, -0.000737, -0.000675, -0.000621, -0.000534, -0.00047, -0.000446, -0.000426,
     1                      -0.000397, -0.00035, -0.0002, -0.00012, -0.0001, -0.000095, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
     1                       0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0  / 
      data  h  / 5.1, 6.9, 5.1, 5.06, 5.03, 4.99, 4.99, 4.99, 5.01, 5.03, 5.03, 5.03, 5.01, 4.99, 4.98, 4.97,
     1           4.96, 4.94, 4.9, 4.9, 4.9, 4.9, 4.9, 4.9, 4.88, 4.85, 4.83, 4.81, 4.8, 4.79, 4.76, 4.77, 4.77,
     1           4.78, 4.78, 4.78, 4.76, 4.76, 4.77, 4.79, 4.78, 4.8, 4.81, 4.83, 4.88, 4.91, 4.94, 5, 5.05, 5.07,
     1           5.1, 5.15, 5.19, 5.23, 5.27, 5.28, 5.3, 5.33, 5.35, 5.4, 5.49, 5.62, 5.67, 5.78, 5.96, 6.16, 6.37,
     1           6.56, 6.75, 6.94, 7.33, 7.7, 8.07, 8.4, 8.72, 8.99, 9.17, 9.31, 9.46, 9.56, 9.6, 9.53, 9.49, 9.46,
     1           9.45, 9.49, 9.51, 9.48, 9.47, 9.48, 9.49, 9.51, 9.52, 9.54, 9.54, 9.53, 9.5, 9.36, 9.1, 8.69, 8.29,
     1           7.81, 7.37, 6.8, 6.43, 6.13, 5.93  / 
      data  cv  / -0.329, -0.518, -0.329, -0.318, -0.311, -0.301, -0.298, -0.297, -0.298, -0.3, -0.304, -0.319,
     1            -0.324, -0.331, -0.339, -0.349, -0.358, -0.365, -0.372, -0.38, -0.386, -0.392, -0.397, -0.4,
     1            -0.403, -0.404, -0.404, -0.404, -0.404, -0.403, -0.402, -0.401, -0.4, -0.4, -0.4, -0.4, -0.401,
     1            -0.402, -0.403, -0.403, -0.402, -0.401, -0.4, -0.398, -0.396, -0.393, -0.39, -0.388, -0.385,
     1            -0.382, -0.38, -0.38, -0.38, -0.381, -0.384, -0.388, -0.393, -0.4, -0.406, -0.413, -0.421, 
     1            -0.431, -0.441, -0.452, -0.464, -0.475, -0.486, -0.497, -0.508, -0.518, -0.528, -0.538, -0.547,
     1            -0.557, -0.567, -0.578, -0.59, -0.602, -0.613, -0.625, -0.638, -0.645, -0.648, -0.651, -0.652,
     1            -0.645, -0.641, -0.63, -0.628, -0.623, -0.611, -0.6, -0.59, -0.578, -0.563, -0.544, -0.522,
     1            -0.476, -0.437, -0.4, -0.366, -0.338, -0.317, -0.303, -0.292, -0.284, -0.2767  / 
      data  vc  / 1500, 1300, 1500, 1500.1, 1501, 1501, 1502, 1502, 1502, 1503, 1503, 1502.9, 1502, 1502,
     1            1502,1502, 1501.9, 1501.1, 1500, 1499.1, 1497.4, 1496.7, 1495.5, 1493.2, 1490.7, 1488.1,
     1            1485.6, 1482.3, 1480, 1473.7, 1466.2, 1458.5, 1456, 1450.2, 1441.2, 1431.6, 1422.3, 1413.7,
     1            1405.4, 1396.5, 1378.9, 1360.9, 1352.9, 1344.5, 1329.1, 1320.8, 1313.4, 1298.7, 1286.3,
     1            1280,1273.8, 1262.1, 1252.1, 1242.5, 1233.6, 1229.7, 1225.9, 1218.6, 1212.4, 1195.9,
     1            1181.6, 1170.1, 1166.6, 1159.5, 1149.7, 1140.1, 1132.2, 1124.7, 1118.6, 1113, 1103.7, 
     1            1095.2, 1086.5, 1077.2, 1067.4, 1056.4, 1045.3, 1034.9, 1024.6, 1014.4, 992.76, 973.49,
     1            964.54, 956.16, 939.01, 921.23, 904.14, 888.7, 881.42, 874.26, 860.43, 847.56, 835.89, 
     1            825.46, 816.48, 809.05, 802.67, 790.21, 782.06, 776.36, 772.82, 770.95, 770.1, 768.53, 
     1            768.71, 771.66, 775  / 
      data  f4  / -0.05, -0.03, -0.05, -0.0501, -0.0501, -0.0501, -0.0498, -0.0497, -0.0497, -0.0504,
     1            -0.0508, -0.0535, -0.0553, -0.0573, -0.0584, -0.0594, -0.0616, -0.0636, -0.0682, -0.0715,
     1            -0.0734, -0.0739, -0.0745, -0.0749, -0.0751, -0.075, -0.0747, -0.0742, -0.0736, -0.0717,
     1            -0.0692, -0.0664, -0.0655, -0.0635, -0.0607, -0.0581, -0.0557, -0.0534, -0.0512, -0.0492,
     1            -0.0461, -0.0435, -0.0424, -0.0416, -0.0402, -0.0397, -0.039, -0.038, -0.0371, -0.0367,
     1            -0.0362, -0.0354, -0.0348, -0.0343, -0.0339, -0.0337, -0.0335, -0.033, -0.0325, -0.031,
     1            -0.0296, -0.0285, -0.028, -0.0272, -0.026, -0.0249, -0.0239, -0.0231, -0.0222, -0.0215,
     1            -0.0202, -0.0191, -0.0178, -0.0164, -0.0152, -0.0141, -0.0129, -0.0118, -0.0109, -0.0102,
     1            -0.00896, -0.0079, -0.00742, -0.00697, -0.00615, -0.00543, -0.00479, -0.00423, -0.00397,
     1            -0.00373, -0.0033, -0.00293, -0.00257, -0.00224, -0.00192, -0.00161, -0.00135, -0.000823,
     1            -0.000456, -0.000215, -0.0000704, -0.00000679, 0.0, 0.0, 0.0, 0.0, 0.0  / 
      data  f5  / -0.00701, -0.00844, -0.00701, -0.007279, -0.007311, -0.007336, -0.00731, -0.007293,
     1            -0.007246, -0.007148, -0.007111, -0.006937, -0.006844, -0.006749, -0.006702, -0.006655,
     1            -0.006564, -0.006476, -0.006275, -0.006105, -0.005968, -0.005922, -0.00586, -0.005778,
     1            -0.005719, -0.005678, -0.005652, -0.005639, -0.005636, -0.005653, -0.005691, -0.005742,
     1            -0.005758, -0.005797, -0.005855, -0.005915, -0.005976, -0.006036, -0.006096, -0.006156,
     1            -0.006273, -0.006388, -0.006444, -0.006499, -0.006605, -0.006655, -0.006704, -0.006799,
     1            -0.006887, -0.006929, -0.00697, -0.007047, -0.007122, -0.007192, -0.007259, -0.007292,
     1            -0.007324, -0.007387, -0.007449, -0.007598, -0.007739, -0.00787, -0.007912, -0.007989,
     1            -0.008094, -0.008184, -0.008258, -0.008315, -0.008356, -0.008378, -0.008363, -0.008264,
     1            -0.008062, -0.007762, -0.007375, -0.006918, -0.006419, -0.005903, -0.005387, -0.004886,
     1            -0.003985, -0.003255, -0.002959, -0.002707, -0.002307, -0.002025, -0.001836, -0.00171,
     1            -0.001662, -0.001625, -0.001568, -0.00153, -0.001504, -0.001485, -0.00147, -0.001457,
     1            -0.001446, -0.001417, -0.001396, -0.001383, -0.001375, -0.001371, -0.001368, -0.001368,
     1            -0.001366, -0.001363, -0.00136  / 
      data  tau1  / 0.47631, 0.38571, 0.48088, 0.48986, 0.50166, 0.51211, 0.52178, 0.53152, 0.54117,
     1              0.54987, 0.55808, 0.56537, 0.57111, 0.5764, 0.58036, 0.58236, 0.58365, 0.58317, 0.58127,
     1              0.57818, 0.57413, 0.56897, 0.56264, 0.55545, 0.54698, 0.53771, 0.52787, 0.51796, 0.50759,
     1              0.49674, 0.4855, 0.47414, 0.46295, 0.452, 0.4411, 0.43033, 0.41998, 0.41042, 0.40067, 0.39107,
     1              0.38255, 0.37488, 0.36761, 0.36064, 0.3542, 0.34827, 0.34336, 0.33929, 0.33577, 0.33291, 0.33102,
     1              0.32955, 0.32873, 0.32888, 0.3305, 0.3331, 0.33668, 0.34092, 0.3466, 0.35369, 0.36128, 0.36905, 
     1              0.37718, 0.38573, 0.39468, 0.40371, 0.41267, 0.42177, 0.43138, 0.44039, 0.44865, 0.45699, 
     1              0.46569, 0.4745, 0.48287, 0.49017, 0.49619, 0.5015, 0.50599, 0.50993, 0.51349, 0.5165, 0.5187,
     1              0.52015, 0.52097, 0.52179, 0.52305, 0.52408, 0.52485, 0.52561, 0.52656, 0.52701, 0.52914, 
     1              0.53211, 0.53349, 0.53685, 0.53961, 0.53757, 0.53492, 0.53281, 0.52963, 0.52521, 0.50744, 
     1              0.49611, 0.493, 0.48988, 0.48361  / 
      data  tau2  / 0.37634, 0.34879, 0.38052, 0.38818, 0.39681, 0.40462, 0.4118, 0.41915, 0.42658, 0.43291, 
     1              0.43902, 0.4449, 0.4502, 0.4562, 0.46245, 0.46826, 0.47388, 0.47865, 0.48279, 0.4861, 
     1              0.48862, 0.49021, 0.49063, 0.49009, 0.48743, 0.48252, 0.47587, 0.46886, 0.46128, 0.45327,
     1              0.445, 0.43678, 0.42907, 0.42226, 0.41616, 0.41044, 0.40507, 0.40114, 0.39772, 0.39407, 
     1              0.39038, 0.3867, 0.38296, 0.37935, 0.37544, 0.37113, 0.36726, 0.36432, 0.36162, 0.35912,
     1              0.35746, 0.35635, 0.35508, 0.35348, 0.35127, 0.34994, 0.34969, 0.34988, 0.35009, 0.34934,
     1              0.34783, 0.34636, 0.34554, 0.34616, 0.34832, 0.35201, 0.35536, 0.35813, 0.36128, 0.36527,
     1              0.37022, 0.37512, 0.37939, 0.38315, 0.38675, 0.39115, 0.39502, 0.39819, 0.40069, 0.40204,
     1              0.4021, 0.40148, 0.40085, 0.40044, 0.3998, 0.39886, 0.39689, 0.39438, 0.39179, 0.38959,
     1              0.38729, 0.38482, 0.38235, 0.38034, 0.3798, 0.38183, 0.38549, 0.38679, 0.38948, 0.39253,
     1              0.39481, 0.39851, 0.40286, 0.41629, 0.41771, 0.418, 0.4184  / 
      data  phi1  / 0.71175, 0.58241, 0.7145, 0.71842, 0.72473, 0.7309, 0.73706, 0.74357, 0.74967, 0.75553,
     1              0.76129, 0.7667, 0.77122, 0.77588, 0.78032, 0.78388, 0.78704, 0.78898, 0.78996, 0.79012,
     1              0.78988, 0.78934, 0.78845, 0.78729, 0.7856, 0.78355, 0.78144, 0.77937, 0.77723, 0.77496,
     1              0.77239, 0.76941, 0.76592, 0.76189, 0.75743, 0.75224, 0.74608, 0.73979, 0.7334, 0.72692,
     1              0.72077, 0.71489, 0.70866, 0.70194, 0.69533, 0.68878, 0.68223, 0.67601, 0.6696, 0.66299,
     1              0.65662, 0.65034, 0.64402, 0.63827, 0.63273, 0.62713, 0.62163, 0.61666, 0.6114, 0.60584,
     1              0.60059, 0.59562, 0.59069, 0.58583, 0.58105, 0.57688, 0.5732, 0.56959, 0.56586, 0.5627,
     1              0.56, 0.55702, 0.55374, 0.55065, 0.54793, 0.5449, 0.54147, 0.53791, 0.5345, 0.53133, 
     1              0.52829, 0.52515, 0.52186, 0.51853, 0.51491, 0.5107, 0.50642, 0.50215, 0.49792, 0.49358,
     1              0.489, 0.48369, 0.47779, 0.47172, 0.46516, 0.45784, 0.44984, 0.44248, 0.43556, 0.42732, 
     1              0.41907, 0.41093, 0.40174, 0.39884, 0.38229, 0.37895, 0.37531  / 
      data  phi2  / 0.53387, 0.59672, 0.53338, 0.53832, 0.54263, 0.54692, 0.55165, 0.55669, 0.56253, 0.56688,
     1              0.5712, 0.57554, 0.57948, 0.58323, 0.5868, 0.58984, 0.59264, 0.59452, 0.596, 0.59731,
     1              0.59879, 0.60035, 0.60176, 0.60305, 0.60433, 0.60534, 0.60605, 0.60665, 0.60694, 0.6067,
     1              0.60589, 0.60455, 0.60277, 0.60064, 0.59834, 0.59616, 0.5939, 0.5919, 0.59015, 0.58894,
     1              0.58828, 0.58799, 0.58803, 0.58831, 0.5888, 0.58938, 0.58959, 0.58966, 0.58953, 0.58928,
     1              0.58886, 0.58843, 0.58813, 0.58788, 0.58779, 0.58778, 0.58804, 0.58865, 0.58959, 0.59069,
     1              0.5919, 0.59324, 0.59468, 0.59622, 0.59794, 0.60008, 0.60269, 0.60562, 0.60904, 0.61298,
     1              0.61729, 0.62157, 0.62567, 0.62969, 0.63347, 0.63652, 0.63887, 0.64067, 0.64182, 0.64194,
     1              0.64107, 0.63976, 0.63872, 0.63798, 0.63739, 0.6369, 0.63678, 0.63691, 0.63691, 0.63656, 
     1              0.63664, 0.63725, 0.63808, 0.63903, 0.63997, 0.64043, 0.63998, 0.63865, 0.63641, 0.63347,
     1              0.62962, 0.628, 0.62596, 0.61769, 0.60829, 0.59272, 0.58136  / 
     


C     Set constant parameters
      mref = 4.5
      rref = 1.0
      vref = 760.0
      f1 = 0.0
      f3 = 0.1

C First check for the PGA case (i.e., specT=0.0) 
      nPer = 107
      if (specT .eq. 0.0) then
         period1 = period(1)
         e0T = e0(1)
         e1T = e1(1)
         e2T = e2(1)
         e3T = e3(1)
         e4T = e4(1)
         e5T = e5(1)
         e6T = e6(1)
         mhT = mh(1)
         c1T = c1(1)
         c2T = c2(1)
         c3T = c3(1)        
         hT = h(1)
         VcT = vc(1)
         Dc3GlobalT = DC3global(1)
         Dc3ChinaTrkT = DC3ChinaTrk(1)
         Dc3ItalyJapanT = DC3ItalyJapan(1)
         f4T = f4(1)
         f5T = f5(1)
         cvT = cv(1)
         phi1T = phi1(1)
         tau1T = tau1(1)
         phi2T = phi2(1)
         tau2T = tau2(1)

         goto 1011
      elseif (specT .eq. -1.0) then
         period1 = period(2)
         e0T = e0(2)
         e1T = e1(2)
         e2T = e2(2)
         e3T = e3(2)
         e4T = e4(2)
         e5T = e5(2)
         e6T = e6(2)
         mhT = mh(2)
         c1T = c1(2)
         c2T = c2(2)
         c3T = c3(2)        
         hT = h(2)
         VcT = vc(2)
         Dc3GlobalT = DC3global(2)
         Dc3ChinaTrkT = DC3ChinaTrk(2)
         Dc3ItalyJapanT = DC3ItalyJapan(2)
         f4T = f4(2)
         f5T = f5(2)
         cvT = cv(2)
         phi1T = phi1(2)
         tau1T = tau1(2)
         phi2T = phi2(2)
         tau2T = tau2(2)

         goto 1011
      else 
C Now loop over the spectral period range of the attenuation relationship.
         do i=3,nper-1
            if (specT .ge. period(i) .and. specT .le. period(i+1) ) then
               count1 = i
               count2 = i+1
               goto 1020 
            endif
         enddo
      endif

C Selected spectral period is outside range defined by attenuaton model.
      write (*,*) 
      write (*,*) 'SSBA (NGA West2-2015) Vertical'
      write (*,*) 'attenuation model is not defined for a '
      write (*,*) ' spectral period of: ' 
      write (*,'(a10,f10.5)') ' Period = ',specT
      write (*,*) 'This spectral period is outside the defined'
      write (*,*) 'period range in the code or beyond the range'
      write (*,*) 'of spectral periods for interpolation.'
      write (*,*) 'Please check the input file.'
      write (*,*) 
      stop 99

C Interpolate the coefficients for the requested spectral period.
 1020       call interp (period(count1),period(count2),e0(count1),e0(count2),
     +                   specT,e0T,iflag)
            call interp (period(count1),period(count2),e1(count1),e1(count2),
     +                   specT,e1T,iflag)
            call interp (period(count1),period(count2),e2(count1),e2(count2),
     +                   specT,e2T,iflag)
            call interp (period(count1),period(count2),e3(count1),e3(count2),
     +                   specT,e3T,iflag)
            call interp (period(count1),period(count2),e4(count1),e4(count2),
     +                   specT,e4T,iflag)
            call interp (period(count1),period(count2),e5(count1),e5(count2),
     +                   specT,e5T,iflag)
            call interp (period(count1),period(count2),e6(count1),e6(count2),
     +                   specT,e6T,iflag)
            call interp (period(count1),period(count2),mh(count1),mh(count2),
     +                   specT,mhT,iflag)
            call interp (period(count1),period(count2),c1(count1),c1(count2),
     +                   specT,c1T,iflag)
            call interp (period(count1),period(count2),c2(count1),c2(count2),
     +                   specT,c2T,iflag)
            call interp (period(count1),period(count2),c3(count1),c3(count2),
     +                   specT,c3T,iflag)
            call interp (period(count1),period(count2),h(count1),h(count2),
     +                   specT,hT,iflag)
            call interp (period(count1),period(count2),DC3Global(count1),DC3Global(count2),
     +                   specT,DC3GlobalT,iflag)
            call interp (period(count1),period(count2),DC3ChinaTrk(count1),DC3ChinaTrk(count2),
     +                   specT,DC3ChinaTrkT,iflag)
            call interp (period(count1),period(count2),DC3ItalyJapan(count1),DC3ItalyJapan(count2),
     +                   specT,DC3ItalyJapanT,iflag)
            call interp (period(count1),period(count2),Vc(count1),Vc(count2),
     +                   specT,VcT,iflag)
            call interp (period(count1),period(count2),f4(count1),f4(count2),
     +                   specT,f4T,iflag)
            call interp (period(count1),period(count2),f5(count1),f5(count2),
     +                   specT,f5T,iflag)
            call interp (period(count1),period(count2),cv(count1),cv(count2),
     +                   specT,cvT,iflag)
            call interp (period(count1),period(count2),phi1(count1),phi1(count2),
     +                   specT,phi1T,iflag)
            call interp (period(count1),period(count2),phi2(count1),phi2(count2),
     +                   specT,phi2T,iflag)
            call interp (period(count1),period(count2),tau1(count1),tau1(count2),
     +                   specT,tau1T,iflag)
            call interp (period(count1),period(count2),tau2(count1),tau2(count2),
     +                   specT,tau2T,iflag)

 1011 period1 = specT                                                                                                              

C.....Set the mechanism terms based on ftype............
C     Set mechanism term and corresponding Frv and Fnm values.
C     fType     Mechanism                      Rake
C     ------------------------------------------------------
C      -1       Normal                    -120 < Rake <  -60
C     -0.5      Normal/Oblique            -150 < Rake < -120
C                                          -60 < Rake <  -30
C       0       Strike-Slip               -180 < Rake < -150
C                                          -30 < Rake <   30
C                                          150 < Rake <  180
C      0.5      Reverse/Oblique             30 < Rake <   60
C                                          120 < Rake <  150
C       1       Reverse                     60 < Rake <  120 
C     Note: Unknown Mechanism is not currently coded.  
      if (ftype .eq. -1.0) then
         mechS = 0.0
         mechN = 1.0
         mechR = 0.0
      elseif (ftype .eq. -0.5) then 
         mechS = 0.0
         mechN = 1.0
         mechR = 0.0
      elseif (ftype .eq. 0.0) then 
         mechS = 1.0
         mechN = 0.0
         mechR = 0.0
      elseif (ftype .eq. 0.5) then
         mechS = 0.0
         mechN = 0.0
         mechR = 1.0
      elseif (ftype .eq. 1.0) then
         mechS = 0.0
         mechN = 0.0
         mechR = 1.0
      endif 

C.....First compute the Reference Rock PGA value...........
C.....This will include the regional dependence for PGA....
C.....MAGNITUDE DEPENDENCE.................................
      if (mag .le. mh(1)) then
         term1 = e1(1)*mechS + e2(1)*mechN + e3(1)*mechR +
     1           e4(1)*(mag-mh(1)) + e5(1)*(mag-mh(1))**2.0
      else
         term1 = e1(1)*mechS + e2(1)*mechN + e3(1)*mechR +
     1           e6(1)*(mag-mh(1))
      endif
C.....Distance dependence......
      Rp = SQRT( Rbjf*Rbjf+h(1)*h(1) )

C.....Apply Regional term.....
      if (regionflag .eq. 0) then
         TERM2 = ( c1(1) + c2(1)*(mag-mref) ) * alog(Rp/rref) + 
     1          ( c3(1) + DC3global(1) ) * (Rp-rref)
      elseif (regionflag .eq. 1) then
         TERM2 = ( c1(1) + c2(1)*(mag-mref) ) * alog(Rp/rref) + 
     1          ( c3(1) + DC3ChinaTrk(1) ) * (Rp-rref)
      elseif (regionflag .eq. 2) then
         TERM2 = ( c1(1) + c2(1)*(mag-mref) ) * alog(Rp/rref) + 
     1          ( c3(1) + DC3ItalyJapan(1) ) * (Rp-rref)      
      endif
      
      pga4nl = exp(term1+term2)


C.....Now compute the requested ground motion value........
C.....MAGNITUDE DEPENDENCE.................................
      if (mag .le. mhT) then
         term1 = e1T*mechS + e2T*mechN + e3T*mechR +
     1           e4T*(mag-mhT) + e5T*(mag-mhT)**2.0
      else
         term1 = e1T*mechS + e2T*mechN + e3T*mechR +
     1           e6T*(mag-mhT)
      endif

C.....Distance dependence......
      R = SQRT( Rbjf*Rbjf+hT*hT )

C     Now apply the regional attenuation differnece.
C     Global Case
C     For vertical set DC3 term = 0.0
      if (regionflag .eq. 0) then
         TERM2 = ( c1T + c2T*(mag-mref) ) * alog(R/rref) + 
     1       ( c3T + DC3globalT) * (R-rref) 
C     China-Turkey Case
      elseif (regionflag .eq. 1) then
         TERM2 = ( c1T + c2T*(mag-mref) ) * alog(R/rref) + 
     1       ( c3T + DC3ChinaTrkT)  * (R-rref) 
C     Italy-Japan Case
      elseif (regionflag .eq. 2) then
         TERM2 = ( c1T + c2T*(mag-mref) ) * alog(R/rref) + 
     1       ( c3T + DC3ItalyJapanT)  * (R-rref) 
      endif

C.....Site Response Term.........
C.....Now compute the site term........
C.....First the linear term......

      if (vs .lt. VcT ) then
         flin = cvT*alog(Vs/Vref)
      else
         flin = cvT*alog(VcT/Vref)
      endif

C.....Next the non-linear term......
      f2 = f4T*(exp(f5T*(min(vs,760.0)-360.0))-exp(f5T*(760.0-360.0))) 

      TERM3 = flin + f1 + f2*alog((pga4nl+f3)/f3) 
      
      lnY = term1 + term2 + term3 
      period2 = period1

C     Compute magnitude dependence on tau and phi values. 
      if (mag .le. 4.5) then
         tau = tau1T
      elseif (mag .gt. 4.5 .and. mag .lt. 5.5) then
         tau = tau1T + (tau2T - tau1T)*(mag - 4.5)
      else
         tau = tau2T
      endif
      if (mag .le. 4.5) then
         phi = phi1T
      elseif (mag .gt. 4.5 .and. mag .lt. 5.5) then
         phi = phi1T + (phi2T - phi1T)*(mag - 4.5)
      else
         phi = phi2T
      endif
      
      sigma = sqrt (tau**2 + phi**2)

C     Convert ground motion to units of gals.
      lnY = lnY + 6.89
      
      return
      END

c ---------------------------------------------------------------------            
C     *** Campbell and Bozorgnia NGA West2 (NGA-2013) ***
C         Earthquake Spectra Paper:
C            Campbell-Bozorgnia NGA-West2 ground motion model
C                for the average horizontal components of PGA, 
C                PGV, and 5%-damped linear Response Spectra
C             K. W. Campbel and Y. Bozorgnia
C     Notes:
C        Applicable Range:
C            3.3 < M < 8.5 (strike-slip)
C            3.3 < M < 8.0 (reverse)
C            3.3 < M < 7.5 (normal)
C            Distance < 300km
C            150 < Vs30m < 1500 m/s
C            0 < Z25 < 10 km
C            0 < Zhyp < 20 km
C            15 < Dip < 90 
C        Report provides formulation for estimating recommended
C           parameters when they are not defined (e.g., Z25 given Vs30m).
C           See Chapter 06 of the report. 
c ---------------------------------------------------------------------------            

      subroutine BC_NGAWest2_2013_Vert ( mag, Rrup, Rbjf, Ftype, specT, 
     1                     period2, lnY, sigma, iflag, vs,
     2                     depthtop, D25, Dip, depth, HWflag, Rx, rupwidth, regionflag, phi, tau ) 

C     Last Updated: 5/22/14

      implicit none

      integer MAXPER, iflag, i, nPer
      parameter (MAXPER=23)
      REAL Period(MAXPER), C0(MAXPER), C1(MAXPER), C2(MAXPER), C3(MAXPER), C4(MAXPER), C5(MAXPER)
      REAL C6(MAXPER), C7(MAXPER), C8(MAXPER), C9(MAXPER), C10(MAXPER), C11(MAXPER), C12(MAXPER)
      REAL C13(MAXPER), C14(MAXPER), C15(MAXPER), C16(MAXPER), C17(MAXPER), C18(MAXPER), C19(MAXPER)
      REAL A2(MAXPER), h1(MAXPER), h2(MAXPER), h3(MAXPER), h4(MAXPER)
      REAL h5(MAXPER), h6(MAXPER)
      REAL K1(MAXPER), K2(MAXPER), K3(MAXPER)
      REAL C20(MAXPER), DC20CA(MAXPER), DC20JP(MAXPER), DC20CH(MAXPER)
      REAL T1(MAXPER), T2(MAXPER), phi1(MAXPER), Phi2(MAXPER), phic(MAXPER)
      REAL flnAF(MAXPER), rho(MAXPER), period2, specT, sigma, depthtop, depth

      REAL MAG, RRUP, RBJF, VS, D25, FHWR, FHWM, FHWZ, FHWD, PGAROCK, C, N
      real lnY, ftype, Dip, pgasoil, Rx, R1, R2, f1, f2
      real fhypH, D25_RK, TERM1, TERM2, TERM3, TERM4, term5, TERM5_RK, TERM6
      real TERM6_RK, term7, term8, term9, R, rupwidth, period1, psoil2 
      INTEGER count1, count2, HWFlag, regionflag

      real c0T, c1T, c2T, c3T, c4T, c5T, c6T, c7T, c8T, c9T, c10T, c11T, c12T
      real c13T, c14T, c15T ,c16T, c17T, c18T, c19T, c20T, Dc20CAT, Dc20JPT, Dc20CHT
      real k1T, k2T, k3T, a2T, h1T, h2T, h3T, h4T, h5T, h6T
      real t1T, t2T, phi1T, phi2T, phicT
      real rhoT, flnAFT, fhwrrup

      real alpha, tau
      real tau_lnyB, tau_lnPGAB, phi_lnY, phi_lnyB, phi_lnPGAB, phi, sigmatot

C.....MODEL COEFFICIENTS.....................
      Data Period  /  0, -1, 0.01, 0.02, 0.03, 0.05, 0.075, 0.1, 0.15, 0.2, 0.25, 0.3, 
     1                0.4, 0.5, 0.75, 1, 1.5, 2, 3, 4, 5, 7.5, 10  / 
      Data c0  /  -4.729, -3.86, -4.674, -4.548, -4.05, -3.435, -3.435, -3.93, -5.505, -6.28, 
     1            -6.789, -7.4, -8.75, -9.74, -11.05, -12.184, -13.451, -13.7, -13.9, -14.59387, 
     2           -15.63449, -17.12864, -17.65672  / 
      Data c1  /  0.984, 1.51, 0.977, 0.976, 0.931, 0.887, 0.902, 0.993, 1.267, 1.366, 1.458, 1.528, 
     1            1.739, 1.872, 2.021, 2.18, 2.27, 2.271, 2.15, 2.132, 2.116, 2.223, 2.132  / 
      Data c2  /  0.537, 0.27, 0.533, 0.549, 0.628, 0.674, 0.726, 0.698, 0.51, 0.447, 0.274, 0.193, -0.02,
     1           -0.121, -0.042, -0.069, 0.047, 0.149, 0.368, 0.726, 1.027, 0.169, 0.367  / 
      Data c3  /  -1.499, -1.299, -1.485, -1.488, -1.494, -1.388, -1.469, -1.572, -1.669, -1.75, -1.711, 
     1            -1.77, -1.594, -1.577, -1.757, -1.707, -1.621, -1.512, -1.315, -1.506, -1.721, -0.756, -0.8  / 
      Data c4  /  -0.443, -0.379, -0.445, -0.453, -0.464, -0.552, -0.543, -0.47, -0.452, -0.435, -0.41, -0.305, 
     1            -0.446, -0.489, -0.53, -0.624, -0.686, -0.84, -0.890, -0.885, -0.878, -1.077, -1.282  /
      Data c5  /  -2.666, -2.383, -2.665, -2.699, -2.772, -2.76, -2.575, -2.461, -2.349, -2.335, -2.332, -2.297, 
     1            -2.219, -2.205, -2.143, -2.092, -1.913, -1.882, -1.789, -1.78139, -1.68982, -1.72135, -1.948  / 
      Data c6  /  0.214, 0.196, 0.214, 0.215, 0.216, 0.202, 0.177, 0.166, 0.164, 0.175, 0.183, 0.19, 0.185, 
     1            0.191, 0.188, 0.176, 0.144, 0.126, 0.105, 0.10009, 0.098, 0.125, 0.163  / 
      Data c7  /  7.166, 6.274, 7.136, 6.936, 7.235, 8.334, 8.761, 9.049, 8.633, 8.742, 8.4, 7.643, 7.059, 
     1            6.375, 5.166, 5.642, 5.963, 7.584, 8.645, 10.20357, 8.38571, 5.77927, 4.13478  / 
      Data c8  /  0, 0.111, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.016, 0.032, 0.128, 0.255, 0.284, 0.26112,
     1            0.28229, 0.38692, 0.32216  / 
      Data c9  /  -0.23, -0.128, -0.229, -0.27, -0.315, -0.329, -0.29, -0.203, -0.203, -0.203, -0.203,
     1            -0.203, -0.203, -0.203, -0.203, -0.115, -0.005, 0.12, 0.17, 0.17, 0.17747, 0.38278, 0.33417  / 
      Data c10  /  0.759, 0.14, 0.759, 0.768, 0.766, 0.764, 0.795, 0.842, 0.736, 0.801, 0.715, 0.708, 0.683, 
     1             0.704, 0.602, 0.394, 0.328, 0.112, 0.011, 0, 0, 0, 0  / 
      Data c11  /  -0.356, -0.395, -0.354, -0.344, -0.297, -0.363, -0.427, -0.429, -0.421, -0.429, -0.438,
     1             -0.421, -0.401, -0.417, -0.49, -0.539, -0.611, -0.63, -0.562, -0.53663, -0.44173, 
     2             -0.3428, -0.19908  / 
      Data c12  /  1.019, 0.338, 1.015, 0.95, 1.056, 1.316, 1.758, 1.411, 1.227, 0.987, 0.577, 0.279,
     1             0.358, 0.229, 0.574, 0.98, 0.819, 0.044, -0.396, 0.00115, -0.59234, -1.13827, -0.32493 / 
      Data c13  /  0.373, 0.407, 0.372, 0.4, 0.394, 0.422, 0.336, 0.314, 0.289, 0.29, 0.303, 0.336, 0.358, 
     1             0.432, 0.459, 0.442, 0.52, 0.566, 0.562, 0.51499, 0.51133, 0.57479, 0.32431  / 
      Data c14  /  -0.1172, -0.0016, -0.1193, -0.1454, -0.1957, -0.187, -0.095, -0.0999, 0.0017, 0.0402,
     1              0.0468, 0.0255, 0.0606, 0.0904, 0.1776, 0.2389, 0.2758, 0.3051, 0.3482, 0.35267, 
     2              0.30443, 0.16789, 0.16858  / 
      Data c15  /  -0.097, 0.382, -0.094, -0.081, -0.091, -0.29, -0.261, -0.091, -0.092, -0.081, 
     1              0.011, 0.092, 0.122, 0.287, 0.292, 0.316, 0.45, 0.424, 0.3, 0.25726, 0.17039, 
     2              0.21872, 0.12681  / 
      Data c16  /  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data c17  /  0.102, 0.0581, 0.1026, 0.1059, 0.1175, 0.1238, 0.1088, 0.0918, 0.072, 0.0602,
     1             0.05, 0.0382, 0.0264, 0.0163, -0.0016, -0.0072, -0.0262, -0.0408, -0.0512, 
     2            -0.0567, -0.04288, -0.0308, 0.00668  / 
      Data c18  /  0.0442, 0.0294, 0.0452, 0.0427, 0.041, 0.0408, 0.0516, 0.0559, 0.0447, 0.0485, 
     1             0.0416, 0.0438, 0.0307, 0.0287, 0.0277, 0.0277, 0.0293, 0.0221, 0.0321, 0.02249, 
     2             0.02372, 0.0171, -0.00165  / 
      Data c19  /  0.00784, 0.00761, 0.00784, 0.00786, 0.00815, 0.00783, 0.00726, 0.00644, 0.00745, 
     1             0.00789, 0.00629, 0.00524, 0.00522, 0.00539, 0.00501, 0.00506, 0.00353, 0.0022, 
     2            -0.00137, 0.00053, 0.00233, -0.00298, 0.00092  / 
      Data c20  /  -0.0053, -0.0019, -0.0053, -0.0052, -0.0052, -0.0062, -0.0072, -0.0072, -0.0066, -0.0056,
     1             -0.0049, -0.0046, -0.0037, -0.0031, -0.0021, -0.0012, -0.0004, 0, 0, 0, 0, 0, 0  / 
      Data Dc20CA  /  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data Dc20JP  /  -0.0018, 0.0005, -0.0018, -0.0018, -0.002, -0.0026, -0.0021, -0.0018, -0.0018, 
     1                -0.0022, -0.0025, -0.0027, -0.0024, -0.0025, -0.0025, -0.0023, -0.0013, -0.0004,
     2                 0, 0, 0, 0, 0  / 
      Data Dc20CH  /  0.0039, 0.0019, 0.0039, 0.0036, 0.0033, 0.0039, 0.0048, 0.005, 0.0048, 0.0041, 
     1                0.0034, 0.0031, 0.0024, 0.0021, 0.002, 0.0012, 0.0004, 0, 0, 0, 0, 0, 0  / 
      Data a2  /  0.167, 0.596, 0.168, 0.166, 0.167, 0.173, 0.198, 0.174, 0.198, 0.204, 0.185, 0.164, 0.16, 
     1            0.184, 0.216, 0.596, 0.596, 0.596, 0.596, 0.596, 0.596, 0.596, 0.596  / 
      Data h1  /  0.241, 0.117, 0.242, 0.244, 0.246, 0.251, 0.26, 0.259, 0.254, 0.237, 0.206, 0.21, 0.226,
     1            0.217, 0.154, 0.117, 0.117, 0.117, 0.117, 0.117, 0.117, 0.117, 0.117  / 
      Data h2  /  1.474, 1.616, 1.471, 1.467, 1.467, 1.449, 1.435, 1.449, 1.461, 1.484, 1.581, 1.586, 
     1            1.544, 1.554, 1.626, 1.616, 1.616, 1.616, 1.616, 1.616, 1.616, 1.616, 1.616  / 
      Data h3  /  -0.715, -0.733, -0.714, -0.711, -0.713, -0.701, -0.695, -0.708, -0.715, -0.721, 
     1            -0.787, -0.795, -0.77, -0.77, -0.78, -0.733, -0.733, -0.733, -0.733, -0.733, -0.733, 
     2            -0.733, -0.733  / 
      Data h4  /  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1  / 
      Data h5  /  -0.337, -0.128, -0.336, -0.339, -0.338, -0.338, -0.347, -0.391, -0.449, -0.393,
     1            -0.339, -0.447, -0.525, -0.407, -0.371, -0.128, -0.128, -0.128, -0.128, -0.128, 
     2            -0.128, -0.128, -0.128  / 
      Data h6  /  -0.27, -0.756, -0.27, -0.263, -0.259, -0.263, -0.219, -0.201, -0.099, -0.198, 
     1            -0.21, -0.121, -0.086, -0.281, -0.285, -0.756, -0.756, -0.756, -0.756, -0.756,
     2            -0.756, -0.756, -0.756  / 
      Data k1  /  865, 400, 865, 865, 908, 1054, 1086, 1032, 878, 748, 654, 587, 503, 457, 410, 
     1            400, 400, 400, 400, 400, 400, 400, 400  / 
      Data k2  /  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data k3  /  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data phi1  /  0.6939, 0.6081, 0.6949, 0.7002, 0.7215, 0.7513, 0.7401, 0.7233, 0.7306, 0.7006, 
     1            0.6867, 0.6683, 0.6275, 0.606, 0.5677, 0.536, 0.511, 0.5069, 0.4744, 0.4659,
     2            0.4301, 0.3859, 0.3952  / 
      Data phi2  /  0.4931, 0.4422, 0.4941, 0.5084, 0.536, 0.5844, 0.5783, 0.5704, 0.5361, 0.51, 
     1            0.5074, 0.5141, 0.5208, 0.5262, 0.5361, 0.5504, 0.559, 0.5706, 0.5573, 0.5664,
     2            0.5675, 0.527, 0.4807  / 
      Data t1  /  0.4612, 0.3344, 0.4617, 0.4741, 0.5291, 0.5761, 0.5231, 0.461, 0.3913, 0.3625,
     1            0.3546, 0.3551, 0.3595, 0.3762, 0.4156, 0.4719, 0.5065, 0.5386, 0.5147, 0.5531,
     2            0.5783, 0.5998, 0.4946  / 
      Data t2  /  0.3471, 0.2399, 0.3445, 0.3753, 0.4164, 0.4681, 0.4266, 0.3902, 0.3428, 0.308,
     1            0.2877, 0.2653, 0.2796, 0.2844, 0.3221, 0.3105, 0.3288, 0.3451, 0.335, 0.3305,
     2            0.2939, 0.3793, 0.4415  / 
      Data flnAF / 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 
     1             0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3, 0.3  / 
      Data phiC  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data rho  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 

      nPer = 23
      c =  0.0
      n = 0.0

C First check for the PGA case (i.e., specT=0.0) 
      if (specT .eq. 0.0) then
         period1 = period(1)
         c0T = c0(1)
         c1T = c1(1)
         c2T = c2(1)
         c3T = c3(1)
         c4T = c4(1)
         c5T = c5(1)
         c6T = c6(1)
         c7T = c7(1)
         c8T = c8(1)
         c9T = c9(1)
         c10T = c10(1)
         c11T = c11(1)
         c12T = c12(1)
         c13T = c13(1)
         c14T = c14(1)
         c15T = c15(1)
         c16T = c16(1)
         c17T = c17(1)
         c18T = c18(1)
         c19T = c19(1)

         a2T = a2(1)
         h1T = h1(1)
         h2T = h2(1)
         h3T = h3(1)
         h4T = h4(1)
         h5T = h5(1)
         h6T = h6(1)

         k1T = k1(1)
         k2T = k2(1)
         k3T = k3(1)
         c20T = c20(1)
         Dc20CAT = Dc20CA(1)
         Dc20JPT = Dc20JP(1)
         Dc20CHT = Dc20CH(1)
         
         phi1T = phi1(1)
         phi2T = phi2(1)
         t1T = t1(1)
         t2T = t2(1)
         flnAFT = flnaf(1)
         phicT = phic(1)
         rhoT = rho(1)

         goto 1011
      elseif (specT .eq. -1.0) then
         period1 = period(2)
        c0T = c0(2)
         c1T = c1(2)
         c2T = c2(2)
         c3T = c3(2)
         c4T = c4(2)
         c5T = c5(2)
         c6T = c6(2)
         c7T = c7(2)
         c8T = c8(2)
         c9T = c9(2)
         c10T = c10(2)
         c11T = c11(2)
         c12T = c12(2)
         c13T = c13(2)
         c14T = c14(2)
         c15T = c15(2)
         c16T = c16(2)
         c17T = c17(2)
         c18T = c18(2)
         c19T = c19(2)
         
         a2T = a2(2)
         h1T = h1(2)
         h2T = h2(2)
         h3T = h3(2)
         h4T = h4(2)
         h5T = h5(2)
         h6T = h6(2)

         k1T = k1(2)
         k2T = k2(2)
         k3T = k3(2)
         c20T = c20(2)
         Dc20CAT = Dc20CA(2)
         Dc20JPT = Dc20JP(2)
         Dc20CHT = Dc20CH(2)
         
         phi1T = phi1(2)
         phi2T = phi2(2)
         t1T = t1(2)
         t2T = t2(2)
         flnAFT = flnaf(2)
         phicT = phic(2)
         rhoT = rho(2)

         goto 1011

      elseif (specT .gt. 0.0) then
C Now loop over the spectral period range of the attenuation relationship.
         do i=3,nper-1
            if (specT .ge. period(i) .and. specT .le. period(i+1) ) then
               count1 = i
               count2 = i+1
               goto 1020 
            endif
         enddo
      endif

C Selected spectral period is outside range defined by attenuaton model.
      write (*,*) 
      write (*,*) 'Bozorgnia&Campbell (NGA West2-2013) Vertical'
      write (*,*) 'attenuation model is not defined for a '
      write (*,*) ' spectral period of: ' 
      write (*,'(a10,f10.5)') ' Period = ',specT
      write (*,*) 'This spectral period is outside the defined'
      write (*,*) 'period range in the code or beyond the range'
      write (*,*) 'of spectral periods for interpolation.'
      write (*,*) 'Please check the input file.'
      write (*,*) 
      stop 99

C Interpolate the coefficients for the requested spectral period.
 1020       call interp (period(count1),period(count2),c0(count1),c0(count2),
     +                   specT,c0T,iflag)
            call interp (period(count1),period(count2),c1(count1),c1(count2),
     +                   specT,c1T,iflag)
            call interp (period(count1),period(count2),c2(count1),c2(count2),
     +                   specT,c2T,iflag)
            call interp (period(count1),period(count2),c3(count1),c3(count2),
     +                   specT,c3T,iflag)
            call interp (period(count1),period(count2),c4(count1),c4(count2),
     +                   specT,c4T,iflag)
            call interp (period(count1),period(count2),c5(count1),c5(count2),
     +                   specT,c5T,iflag)
            call interp (period(count1),period(count2),c6(count1),c6(count2),
     +                   specT,c6T,iflag)
            call interp (period(count1),period(count2),c7(count1),c7(count2),
     +                   specT,c7T,iflag)
            call interp (period(count1),period(count2),c8(count1),c8(count2),
     +                   specT,c8T,iflag)
            call interp (period(count1),period(count2),c9(count1),c9(count2),
     +                   specT,c9T,iflag)
            call interp (period(count1),period(count2),c10(count1),c10(count2),
     +                   specT,c10T,iflag)
            call interp (period(count1),period(count2),c11(count1),c11(count2),
     +                   specT,c11T,iflag)
            call interp (period(count1),period(count2),c12(count1),c12(count2),
     +                   specT,c12T,iflag)
            call interp (period(count1),period(count2),c13(count1),c13(count2),
     +                   specT,c13T,iflag)
            call interp (period(count1),period(count2),c14(count1),c14(count2),
     +                   specT,c14T,iflag)
            call interp (period(count1),period(count2),c15(count1),c15(count2),
     +                   specT,c15T,iflag)
            call interp (period(count1),period(count2),c16(count1),c16(count2),
     +                   specT,c16T,iflag)
            call interp (period(count1),period(count2),c17(count1),c17(count2),
     +                   specT,c17T,iflag)
            call interp (period(count1),period(count2),c18(count1),c18(count2),
     +                   specT,c18T,iflag)
            call interp (period(count1),period(count2),c19(count1),c19(count2),
     +                   specT,c19T,iflag)
            call interp (period(count1),period(count2),a2(count1),a2(count2),
     +                   specT,a2T,iflag)
            call interp (period(count1),period(count2),h1(count1),h1(count2),
     +                   specT,h1T,iflag)
            call interp (period(count1),period(count2),h2(count1),h2(count2),
     +                   specT,h2T,iflag)
            call interp (period(count1),period(count2),h3(count1),h3(count2),
     +                   specT,h3T,iflag)
            call interp (period(count1),period(count2),h4(count1),h4(count2),
     +                   specT,h4T,iflag)
            call interp (period(count1),period(count2),h5(count1),h5(count2),
     +                   specT,h5T,iflag)
            call interp (period(count1),period(count2),h6(count1),h6(count2),
     +                   specT,h6T,iflag)

            call interp (period(count1),period(count2),k1(count1),k1(count2),
     +                   specT,k1T,iflag)
            call interp (period(count1),period(count2),k2(count1),k2(count2),
     +                   specT,k2T,iflag)
            call interp (period(count1),period(count2),k3(count1),k3(count2),
     +                   specT,k3T,iflag)

            call interp (period(count1),period(count2),c20(count1),c20(count2),
     +                   specT,c20T,iflag)
            call interp (period(count1),period(count2),Dc20CA(count1),Dc20CA(count2),
     +                   specT,Dc20CAT,iflag)
            call interp (period(count1),period(count2),Dc20JP(count1),Dc20JP(count2),
     +                   specT,Dc20JPT,iflag)
            call interp (period(count1),period(count2),Dc20CH(count1),Dc20CH(count2),
     +                   specT,Dc20CHT,iflag)
     
            call interp (period(count1),period(count2),phi1(count1),phi1(count2),
     +                   specT,phi1T,iflag)
            call interp (period(count1),period(count2),phi2(count1),phi2(count2),
     +                   specT,phi2T,iflag)
            call interp (period(count1),period(count2),t1(count1),t1(count2),
     +                   specT,t1T,iflag)
            call interp (period(count1),period(count2),t2(count1),t2(count2),
     +                   specT,t2T,iflag)
            call interp (period(count1),period(count2),flnAF(count1),flnAF(count2),
     +                   specT,flnAfT,iflag)
            call interp (period(count1),period(count2),phic(count1),phic(count2),
     +                   specT,phicT,iflag)
            call interp (period(count1),period(count2),rho(count1),rho(count2),
     +                   specT,rhoT,iflag)

 1011 period1 = specT                                                                                                              

C.....COMPUTE ROCK PGA VALUE FIRST.........................
C.....MAGNITUDE DEPENDENCE (Eq 3.2)........................
      IF (MAG .LE. 4.5) THEN
         TERM1 = C0(1) + C1(1)*MAG
      elseif (mag .le. 5.5) then
         TERM1 = C0(1) + c1(1)*MAG + c2(1)*(MAG-4.5)
      elseif (mag .le. 6.5) then
         TERM1 = C0(1) + C1(1)*MAG + c2(1)*(MAG-4.5) + c3(1)*(mag-5.5)
      ELSE
         TERM1 = C0(1) + C1(1)*MAG + c2(1)*(MAG-4.5) + C3(1)*(MAG-5.5) + c4(1)*(mag-6.5)
      ENDIF
      
C.....Distance dependence (Eq 3.3).....
      R = SQRT( RRUP*RRUP+C7(1)*C7(1) )
      TERM2 = (C5(1) + C6(1)*MAG)*ALOG(R)

C.....SET UP STYLE OF FAULTING TERMS (Eq 3.4, 3.5, and 3.6).........

C     Set mechanism term and corresponding Frv and Fnm values.
C     fType     Mechanism                      Rake
C     ------------------------------------------------------
C    -1,-0.5    Normal and NMl/Obl       -150 < Rake < -30.0
C     1, 0.5    Reverse and Rev/Obl        30 < Rake < 150.0
C       0       Strike-Slip                    Otherwise
      IF (Ftype .EQ. 0.0) THEN
         TERM3 = 0.0
      ELSEIF (Ftype .ge. 0.5) THEN
         if (mag .le. 4.5) then
            TERM3 = 0.0
         elseif (mag .le. 5.5) then
            TERM3 = C8(1)*(mag-4.5)
         else
            TERM3 = c8(1)
         endif
      ELSEIF (Ftype .le. -0.5) THEN
         if (mag .le. 4.5) then
            TERM3 = 0.0
         elseif (mag .le. 5.5) then
            TERM3 = C9(1)*(mag-4.5)
         else
            TERM3 = C9(1)
         endif
      ENDIF

C.....SET UP HANGING WALL TERMS (Eq 3.7)..............
      if (HWflag .eq. 1) then
         R1 = rupwidth*cos(abs(dip)*3.14159/180.0)
         R2 = 62.0*mag - 350.0
         f1 = h1(1) + h2(1)*(Rx/R1) + h3(1)*(Rx/R1)**2.0
         f2 = h4(1) + h5(1)*((Rx-R1)/(R2-R1)) + h6(1)*((Rx-R1)/(R2-R1))**2.0
         if (Rrup .eq. 0.0) then
            fhwrrup = 1.0
         else
            fhwrrup = ((Rrup-Rbjf)/Rrup)         
         endif
         if (Rx .lt. R1) Then
            fhwr = f1*fhwrrup
         else
            fhwr = max(f2,0.0)*fhwrrup
         endif
         if (mag .le. 5.5) then
            fhwm = 0.0         
         elseif (mag .le. 6.5) then
            fhwm = (mag-5.5)*(1.0+a2(1)*(mag-6.5))
         else
            fhwm = 1.0 + a2(1)*(mag-6.5)        
         endif
         if (depthtop .le. 16.66) then
            fhwz = 1.0 - 0.06*depthtop 
         else
            fhwz = 0.0
         endif
         fhwd = (90.0 - dip)/45.0        
         TERM4 = c10(1)*fhwr*fhwm*fhwz*fhwd
      else   
         term4 = 0.0
      endif 

C.....NOW COMPUTE THE SITE CONDITION FACTORS...............
C.....(FOR PGA ROCK, VS=1100, i.e., Vs>k1)
      TERM5_RK = (C11(1) + K2(1)*n)*ALOG( 1100.0/K1(1) )
      if (regionflag .eq. 1) then
         TERM5_RK = TERM5_RK + (C13(1) + K2(1)*n)*ALOG( 1100.0/K1(1) )
      endif
C.....NOW COMPUTE THE SEDIMENT DEPTH DEPENDENCE (Eq 3.17)............
C     For Rock PGA the D25 value should be set at the recommended value of D25=0.398
      D25_RK = 0.398
      if (D25_RK .le. 1.0) then
         if (regionflag .eq. 1) then
            TERM6_RK = (C14(1)+c15(1))*(D25_RK-1.0)
         else
            TERM6_RK = C14(1)*(D25_RK-1.0)
         endif   
      elseif (D25_RK .GT. 1.0 .AND. D25_RK .LE. 3.0) then
        TERM6_RK = 0.0
      elseif (D25_RK .GT. 3.0) then
         TERM6_RK = c16(1)*k3(1)*exp(-0.75)*(1.0-exp(-0.25*(D25_RK-3.0)))
      endif

C.....Now compute the hypocentral depth term (Eq 3.21).........
      if (depth .le. 7.0) then
         fhypH = 0.0
      elseif (depth .le. 20.0) then
         fhypH = depth - 7.0      
      else
         fhypH = 13.0
      endif
      if (mag .le. 5.5) then
          term7 = c17(1)*fhypH
      elseif (mag .le. 6.5) then
          term7 = (c17(1) + (c18(1)-c17(1))*(mag-5.5))*fhypH
      else
          term7 = c18(1)*fhypH     
      endif

C.....Compute Rupture Dip term (Eq 3.24)............
      if (mag .le. 4.5) then
          term8 = c19(1)*dip
      elseif (mag .le. 5.5) then
          term8 = c19(1)*(5.5-mag)*dip      
      else 
          term8 = 0.0
      endif

C.....Compute anelastic attenuation term.....
      if (Rrup .le. 80.0) then
         term9 = 0.0
      else      
         if (regionflag .eq. 0) then
            term9 = (c20(1)+Dc20CA(1) ) * (Rrup-80.0)
         elseif (regionflag .eq. 1) then
            term9 = (c20(1)+Dc20JP(1) ) * (Rrup-80.0)
         elseif (regionflag .eq. 2) then
            term9 = (c20(1)+Dc20CH(1) ) * (Rrup-80.0)      
         endif
      endif      
      
      PGAROCK = EXP(TERM1+TERM2+TERM3+TERM4+TERM5_RK+TERM6_RK+TERM7+TERM8+TERM9)
            
C.....For PGA Specific Vs30m Value
      if (vs .le. k1(1) ) then
         term5 = c11(1)*alog(vs/k1(1)) + 
     1           k2(1)*(alog(pgarock+c*((vs/k1(1))**n)) - 
     2           alog(pgarock+c))
      else
         term5 = (c11(1) + k2(1)*n)*alog(vs/k1(1))
      endif
      if (regionflag .eq. 1) then
         term5 = term5 + (c13(1)+k2(1)*n)*alog(1100./k1(1))
      endif

C.....NOW COMPUTE THE SEDIMENT DEPTH DEPENDENCE (Eq 3.17)............
C     For Rock PGA the D25 value should be set at the recommended value of D25=0.398
      if (D25 .le. 1.0) then
         if (regionflag .eq. 1) then
            TERM6 = (C14(1)+c15(1))*(D25-1.0)
         else
            TERM6 = C14(1)*(D25-1.0)
         endif   
      elseif (D25 .GT. 1.0 .AND. D25 .LE. 3.0) then
        TERM6 = 0.0
      elseif (D25 .GT. 3.0) then
         TERM6 = c16(1)*k3(1)*exp(-0.75)*(1.0-exp(-0.25*(D25-3.0)))
      endif

      pgasoil = alog(pgarock) - term5_rk - term6_RK + term5 + term6
      psoil2 = (TERM1+TERM2+TERM3+TERM4+TERM5+TERM6+TERM7+TERM8+TERM9)

c      write (*,*) pgarock, term1, term2, term3, term4, term5_rk, term6, term7, term8, term9
c      write (*,*) term5, exp(pgasoil)
c      write (*,*) exp(pgasoil), exp(psoil2)
c      pause


C.....NOW COMPUTE THE GROUND MOTION VALUES.................
C.....MAGNITUDE DEPENDENCE.................................
      IF (MAG .LE. 4.5) THEN
         TERM1 = C0T + C1T*MAG
      elseif (mag .le. 5.5) then
         TERM1 = C0T + c1T*MAG + c2T*(MAG-4.5)
      elseif (mag .le. 6.5) then
         TERM1 = C0T + C1T*MAG + c2T*(MAG-4.5) + c3T*(mag-5.5)
      ELSE
         TERM1 = C0T + C1T*MAG + c2T*(MAG-4.5) + C3T*(MAG-5.5) + c4T*(mag-6.5)
      ENDIF

C.....Distance dependence......
      R = SQRT( RRUP*RRUP+C7T*C7T )
      TERM2 = (C5T + C6T*MAG)*ALOG(R)

C.....SET UP STYLE OF FAULTING TERMS...........

C     Set mechanism term and corresponding Frv and Fnm values.
C     fType     Mechanism                      Rake
C     ------------------------------------------------------
C    -1,-0.5    Normal and NMl/Obl       -150 < Rake < -30.0
C     1, 0.5    Reverse and Rev/Obl        30 < Rake < 150.0
C       0       Strike-Slip                    Otherwise
      IF (Ftype .EQ. 0.0) THEN
         TERM3 = 0.0
      ELSEIF (Ftype .ge. 0.5) THEN
         if (mag .le. 4.5) then
            TERM3 = 0.0
         elseif (mag .le. 5.5) then
            TERM3 = C8T*(mag-4.5)
         else
            TERM3 = C8T
         endif
      ELSEIF (Ftype .le. -0.5) THEN
         if (mag .le. 4.5) then
            TERM3 = 0.0
         elseif (mag .le. 5.5) then
            TERM3 = C9T*(mag-4.5)
         else
            TERM3 = C9T
         endif
      ENDIF

C.....SET UP HANGING WALL TERMS................
      if (HWflag .eq. 1) then
         R1 = rupwidth*cos(abs(dip)*3.14159/180.0)
         R2 = 62.0*mag - 350.0
         f1 = h1T + h2T*(Rx/R1) + h3T*(Rx/R1)**2.0
         f2 = h4T + h5T*((Rx-R1)/(R2-R1)) + h6T*((Rx-R1)/(R2-R1))**2.0
         if (Rrup .eq. 0.0) then
            fhwrrup = 1.0
         else
            fhwrrup = ((Rrup-Rbjf)/Rrup)         
         endif
         if (Rx .lt. R1) Then
            fhwr = f1*fhwrrup
         else
            fhwr = max(f2,0.0)*fhwrrup
         endif
         if (mag .le. 5.5) then
            fhwm = 0.0         
         elseif (mag .le. 6.5) then
            fhwm = (mag-5.5)*(1.0+a2T*(mag-6.5))
         else
            fhwm = 1.0 + a2T*(mag-6.5)        
         endif
         if (depthtop .le. 16.66) then
            fhwz = 1.0 - 0.06*depthtop 
         else
            fhwz = 0.0
         endif
         fhwd = (90.0 - dip)/45.0        
         TERM4 = c10T*fhwr*fhwm*fhwz*fhwd
      else   
         term4 = 0.0
      endif 

C.....NOW COMPUTE THE SITE CONDITION FACTORS...............
      IF (VS .LE. K1T ) THEN
         TERM5 = C11T*ALOG( VS/K1T ) +
     1           K2T*( ALOG( PGAROCK+c*( (VS/K1T)**N) ) -
     2           ALOG( PGAROCK+c ) )
      ELSE
         TERM5 = ( C11T+K2T*n )*ALOG( VS/K1T )
      ENDIF
c     Add Japan Site Term Effects
      if (regionflag .eq. 1) then
         IF (VS .LE. 200.0 ) THEN
            TERM5 = term5 + (C12T+k2T*n)*(alog(Vs/k1T)-alog(200/k1T))
         ELSE
            TERM5 = term5 + ( C13T+K2T*n )*ALOG( VS/K1T )
         ENDIF
      endif

C.....NOW COMPUTE THE SEDIMENT DEPTH DEPENDENCE.............
      IF (D25 .LE. 1.0) THEN
         if (regionflag .eq. 1) then
            TERM6 = (C14T+c15T)*(D25-1.0)
          else
            TERM6 = C14T*(D25-1.0)
          endif
      ELSEIF (D25 .GT. 1.0 .AND. D25 .LE. 3.0) THEN
         TERM6 = 0.0
      ELSEIF (D25 .GT. 3.0)  THEN
         TERM6 = c16T*k3T*exp(-0.75)*( 1.0 - exp(-0.25*(D25-3.0)))
      ENDIF
      
C.....Now compute the hypocentral depth term..........
      if (depth .le. 7.0) then
         fhypH = 0.0
      elseif (depth .le. 20.0) then
         fhypH = depth - 7.0      
      else
         fhypH = 13.0
      endif
      if (mag .le. 5.5) then
          term7 = c17T*fhypH
      elseif (mag .le. 6.5) then
          term7 = (c17T + (c18T-c17T)*(mag-5.5))*fhypH
      else
          term7 = c18T*fhypH     
      endif

C.....Compute Rupture Dip term.............
      if (mag .le. 4.5) then
          term8 = c19T*dip
      elseif (mag .le. 5.5) then
          term8 = c19T*(5.5-mag)*dip      
      else 
          term8 = 0.0
      endif

C.....Compute anelastic attenuation term.....
      if (Rrup .le. 80.0) then
         term9 = 0.0
      else
         if (regionflag .eq. 0) then
            term9 = (c20T+Dc20CAT)*(Rrup-80.0)
         elseif (regionflag .eq. 1) then
             term9 = (c20T+Dc20JPT)*(Rrup-80.0)
         elseif (regionflag .eq. 2) then
             term9 = (c20T+Dc20CHT)*(Rrup-80.0)
         endif
      endif

      LnY = (TERM1+TERM2+TERM3+TERM4+TERM5+TERM6+TERM7+TERM8+TERM9)

C    Check that SA is not less than PGA for T<0.25sec
      if (specT .lt. 0.25) then
         if (lnY .lt. pgasoil ) then
            lnY = pgasoil
         endif
      endif

C  Set alhpa = 0.0 for current vertical model (8/22/13)
        alpha = 0.0

      If (Mag.le.4.5) then
	   tau_lnyB = t1T
	   tau_lnPGAB = t1(1)
	elseif (Mag.lt.5.5) then
	   tau_lnyB = t2T + 
     &          (t1T - t2T)*(5.5-mag)
	   tau_lnPGAB = t2(1) + 
     &          (t1(1) - t2(1))*(5.5-Mag)
	else
	   tau_lnyB = t2T
	   tau_lnPGAB = t2(1)
	endif

      tau = SQRT(tau_lnyB**2 +  
     &           (alpha * tau_lnPGAB)**2 +
     &           2.0*alpha*rhoT*tau_lnyB*tau_lnPGAB)

      If (Mag.le.4.5) then
	   phi_lny = phi1T
           phi_lnPGAB = phi1(1)
      elseif (Mag.lt.5.5) then
	   phi_lny = phi2T + 
     &          (phi1T - phi2T)*(5.5-mag)
	   phi_lnPGAB = phi2(1) + 
     &          (phi1(1) - phi2(1))*(5.5-mag)
      else
	   phi_lny = phi2T 
	   phi_lnPGAB = phi2(1) 
      endif

      phi_lnyB = SQRT(phi_lny**2 - flnAFT**2)

      phi_lnPGAB = SQRT(phi_lnPGAB**2 - flnAF(1)**2)

      phi = SQRT(phi_lny**2 + 
     &           (alpha*phi_lnPGAB)**2 +
     &           2.0*alpha*rhoT*phi_lnyB*phi_lnPGAB)

      Sigmatot = SQRT(phi**2 + Tau**2)

      period2 = period1
      
C     Convert ground motion to units of gals.
      lnY = lnY + 6.89
      sigma = sigmaTot

      return
      END





c ---------------------------------------------------------------------            
C ** Chiou and Youngs (NGA West2-2013 Model) Vertical **
C      Same function form as horizontal except for linear site response term.
C          For vertical: amp = phi1/(1+(Vs/phi1a)^phi1b)
c
C      Current version is not coded for different regions. 
C        Regional attenuation included based on Regionflag
C             0 = Global
C             1 = Japan/Italy
C             2 = Wenchuan (note only applicable for M7.9 event)
C         Sigma dependent on estimated or measured Vs30m based on 
C             Vs30_Class
C             0 = Estimated Vs30m
C             1 = Measured Vs30m
c ---------------------------------------------------------------------            

      Subroutine CY_NGAWest2_2013_V ( m, Rrup, Rbjf, specT,
     1                     period2, lnY, sigma, iflag, 
     2                     vs, Delta, DTor, Ftype, depthvs10, vs30_class,
     3                     hwflag, Rx, regionflag, phi, tau )

C     Last Updated: 9/26/13

      implicit none
      
      integer MAXPER, i, nPer
      parameter (MAXPER=25)
      REAL Period(MAXPER), C1(MAXPER), C1a(MAXPER), C1b(MAXPER)
      REAL cn(MAXPER), cm(MAXPER), c5(MAXPER), c6(MAXPER)
      REAL c7(MAXPER), c9(MAXPER), gamma1(MAXPER), gamma2(MAXPER)
      REAL phi1(MAXPER), phi2(MAXPER), phi3(MAXPER), phi4(MAXPER)
      REAL phi5(MAXPER), phi6(MAXPER)
      REAL tau1(MAXPER), tau2(MAXPER), sigma1(MAXPER), sigma2(MAXPER)
      REAL sigma3(MAXPER), c9a(MAXPER)
      REAL c3(MAXPER), gm(MAXPER), c9b(MAXPER)
      Real CHM(MAXPER), C1c(MAXPER), C1d(MAXPER), C7b(MAXPER), C8b(MAXPER)
      real C11(MAXPER), C11B(MAXPER)
      real gscaleJapIt(MAXPER), gscaleWen(MAXPER), sigma2Jap(MAXPER)
      real phi1a(MAXPER), phi1b(MAXPER)
      real phi1JP(MAXPER), phi1aJP(MAXPER), phi1bJP(MAXPER), phi5JP(MAXPER), phi6JP(MAXPER)
      real phi1TW(MAXPER), vs, phi
 
      REAL c1T, c1aT, c1bT, cnT, cmT, c5T, c6T, c7T, c9T, c9aT, c3T
      REAL gamma1T, gamma2T, phi1T, phi2T, phi3T, phi4T, sigma3T
      REAL phi5T, phi6T, tau1T, tau2T, sigma1T, sigma2T
      real C1cT, C1dT, C7bT, C11T, C11bT, CHMT
      REAL c2, c4, c4a, cRB, pi, d2r, gamma, gmT, c9bT
      real cc, cosdelta, r1, r2, r3, r4, hw, psa_ref, psa, a, b, c
      integer iflag, count1, count2, hwflag, vs30_class, regionflag
      REAL M, RRUP, RBJF, DTOR, Delta, specT, sigma, Ftype, Rx
      REAL period2, lnY, F_RV, F_NM, depthvs10, tau, rkdepth
      real c8, c8a, c8bT, deltaZ1, fd
      real sigma_NL0, F_Measured, F_Inferred, mz_TOR, deltaZ_TOR, coshM
      real gscaleJapItT, gscaleWenT, sigma2JapT
      real phi1aT, phi1bT, period1
      real phi1JPT, phi1aJPT, phi1bJPT, phi5JPT, phi6JPT, phi1TWT


      data period     /
     1              0.0000, 0.0100, 0.0200, 0.0300, 0.0400, 0.0500,
     1              0.0750, 0.1000, 0.1200, 0.1500, 0.1700,
     1              0.2000, 0.2500, 0.3000, 0.4000, 0.5000,
     1              0.7500, 1.0000, 1.5000, 2.0000, 3.0000,
     1              4.0000, 5.0000, 7.5000,10.0000/
      data c1      /
     1              -2.2621, -2.2621, -2.2629, -2.1389, -1.9451, -1.7424,
     1              -1.3529, -1.2191, -1.2007, -1.2392, -1.2856,
     1              -1.3599, -1.4633, -1.5533, -1.7318, -1.9025,
     1              -2.2740, -2.5805, -3.0470, -3.3941, -3.8807,
     1              -4.2259, -4.4937, -4.9802, -5.3254/
      data c1a     /
     1               0.1650,  0.1650,  0.1650,  0.1650,  0.1650,  0.1650,
     1               0.1650,  0.1650,  0.1650,  0.1650,  0.1650,
     1               0.1650,  0.1650,  0.1650,  0.1650,  0.1650,
     1               0.1650,  0.1650,  0.1650,  0.1645,  0.1168,
     1               0.0732,  0.0484,  0.0220,  0.0124/
      data c1b     /
     1              -0.2550, -0.2550, -0.2550, -0.2550, -0.2550, -0.2550,
     1              -0.2540, -0.2530, -0.2520, -0.2500, -0.2480,
     1              -0.2449, -0.2382, -0.2313, -0.2146, -0.1972,
     1              -0.1620, -0.1400, -0.1184, -0.1100, -0.1040,
     1              -0.1020, -0.1010, -0.1010, -0.1000/
      data c1c     /
     1              -0.1650, -0.1650, -0.1650, -0.1650, -0.1650, -0.1650,
     1              -0.1650, -0.1650, -0.1650, -0.1650, -0.1650,
     1              -0.1650, -0.1650, -0.1650, -0.1650, -0.1650,
     1              -0.1650, -0.1650, -0.1650, -0.1645, -0.1168,
     1              -0.0732, -0.0484, -0.0220, -0.0124/
      data c1d     /
     1               0.2550,  0.2550,  0.2550,  0.2550,  0.2550,  0.2550,
     1               0.2540,  0.2530,  0.2520,  0.2500,  0.2480,
     1               0.2449,  0.2382,  0.2313,  0.2146,  0.1972,
     1               0.1620,  0.1400,  0.1184,  0.1100,  0.1040,
     1               0.1020,  0.1010,  0.1010,  0.1000/
      data cn      /
     1             16.0875, 16.0875, 15.7118, 15.8819, 16.4556, 17.6453,
     1             20.1772, 19.9992, 18.7106, 16.6246, 15.3709,
     1             13.7012, 11.2667,  9.1908,  6.5459,  5.2305,
     1              3.7896,  3.3024,  2.8498,  2.5417,  2.1488,
     1              1.8957,  1.7228,  1.5737,  1.5265/
      data cM      /
     1             4.9993,  4.9993,  4.9993,  4.9993,  4.9993,  4.9993,
     1             5.0031,  5.0172,  5.0315,  5.0547,  5.0704,
     1             5.0939,  5.1315,  5.1670,  5.2317,  5.2893,
     1             5.4109,  5.5106,  5.6705,  5.7981,  5.9983,
     1             6.1552,  6.2856,  6.5428,  6.7415/
      data c3      /
     1               1.8616,  1.8616,  1.8523,  1.8070,  1.7860,  1.7827,
     1               1.8426,  1.9156,  1.9704,  2.0474,  2.0958,
     1               2.1638,  2.2628,  2.3439,  2.4636,  2.5461,
     1               2.6723,  2.7479,  2.8355,  2.8806,  2.9304,
     1               2.9629,  2.9804,  2.9884,  2.9925/
      data c5      /
     1               5.4530,  5.4530,  5.0265,  4.5820,  4.4501,  4.6504,
     1               5.8073,  6.9412,  7.6152,  8.3585,  8.7181,
     1               9.1170,  9.5761,  9.8569, 10.1521, 10.2969,
     1              10.4613, 10.5397, 10.5992, 10.6045, 10.6005,
     1              10.6133, 10.6278, 10.6457, 10.6500/
      data cHM     /
     1             3.0956, 3.0956, 3.0963, 3.0974, 3.0988, 3.1011,
     1             3.1094, 3.2381, 3.3407, 3.4300, 3.4688,
     1             3.5146, 3.5746, 3.6232, 3.6945, 3.7401,
     1             3.7941, 3.8144, 3.8284, 3.8330, 3.8361,
     1             3.8369, 3.8376, 3.8380, 3.8380/
      data c6      /
     1               0.5080,  0.5080,  0.5080,  0.5080,  0.5080,  0.5080,
     1               0.5080,  0.5080,  0.5080,  0.5080,  0.5080,
     1               0.5080,  0.5068,  0.5050,  0.5007,  0.4961,
     1               0.4846,  0.4704,  0.4401,  0.4264,  0.4183,
     1               0.4170,  0.4170,  0.4170,  0.4170/
      data c7      /
     1               0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1               0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1               0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1               0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1               0.0000,  0.0000,  0.0000,  0.0000/
      data c7b     /
     1               0.0855,  0.0855,  0.0871,  0.0957,  0.1032,  0.1066,
     1               0.0952,  0.0829,  0.0750,  0.0654,  0.0601,
     1               0.0531,  0.0430,  0.0340,  0.0183,  0.0056,
     1              -0.0158, -0.0280, -0.0422, -0.0511, -0.0573,
     1              -0.0580, -0.0578, -0.0574, -0.0572/
      data c8b     /
     1             0.4833,  0.4833,  1.2144,  1.6421,  1.9456,  2.1810,
     1             2.6087,  2.9122,  3.1045,  3.3399,  3.4719,
     1             3.6434,  3.8787,  4.0711,  4.3745,  4.6099,
     1             5.0376,  5.3411,  5.7688,  6.0723,  6.5000,
     1             6.8035,  7.0389,  7.4666,  7.7700/
      data c9      /
     1             0.9228,  0.9228,  0.9296,  0.9396,  0.9661,  0.9794,
     1             1.0260,  1.0177,  1.0008,  0.9801,  0.9652,
     1             0.9459,  0.9196,  0.8829,  0.8302,  0.7884,
     1             0.6754,  0.6196,  0.5101,  0.3917,  0.1244,
     1             0.0086,  0.0000,  0.0000,  0.0000/
      data c9a     /
     1             0.1202,  0.1202,  0.1217,  0.1194,  0.1166,  0.1176,
     1             0.1171,  0.1146,  0.1128,  0.1106,  0.1150,
     1             0.1208,  0.1208,  0.1175,  0.1060,  0.1061,
     1             0.1000,  0.1000,  0.1000,  0.1000,  0.1000,
     1             0.1000,  0.1000,  0.1000,  0.1000/
      data c9b     /
     1             6.8607,  6.8607,  6.8697,  6.9113,  7.0271,  7.0959,
     1             7.3298,  7.2588,  7.2372,  7.2109,  7.2491,
     1             7.2988,  7.3691,  6.8789,  6.5334,  6.5260,
     1             6.5000,  6.5000,  6.5000,  6.5000,  6.5000,
     1             6.5000,  6.5000,  6.5000,  6.5000/
      data c11     /
     1                0.0,     0.0,     0.0,     0.0,     0.0,     0.0,
     1                0.0,     0.0,     0.0,     0.0,     0.0,
     1                0.0,     0.0,     0.0,     0.0,     0.0,
     1                0.0,     0.0,     0.0,     0.0,     0.0,
     1                0.0,     0.0,     0.0,     0.0/
      data c11b    /
     1             -0.4536, -0.4536, -0.4536, -0.4536, -0.4536, -0.4536,
     1             -0.4536, -0.4536, -0.4536, -0.4536, -0.4536,
     1             -0.4440, -0.3539, -0.2688, -0.1793, -0.1428,
     1             -0.1138, -0.1062, -0.1020, -0.1009, -0.1003,
     1             -0.1001, -0.1001, -0.1000, -0.1000/
      data gamma1 /
     1            -0.008417, -0.008417, -0.008481, -0.008932, -0.009703, -0.010482,
     1            -0.011693, -0.012062, -0.011818, -0.011159, -0.010722,
     1            -0.010167, -0.009458, -0.008921, -0.008054, -0.007270,
     1            -0.005543, -0.004344, -0.002889, -0.002093, -0.001527,
     1            -0.001335, -0.001222, -0.001049, -0.000965/
      data gamma2 /
     1            -0.004814, -0.004814, -0.004885, -0.005076, -0.004914, -0.004666,
     1            -0.003703, -0.002599, -0.002106, -0.001746, -0.001606,
     1            -0.001439, -0.001180, -0.000906, -0.000467, -0.000349,
     1            -0.000887, -0.001487, -0.002241, -0.002569, -0.002509,
     1            -0.002381, -0.002351, -0.002435, -0.002529/
      data gm /
     1             4.2542,  4.2542,  4.2386,  4.2519,  4.2960,  4.3578,
     1             4.5455,  4.7603,  4.8963,  5.0644,  5.1371,
     1             5.1880,  5.2164,  5.1954,  5.0899,  4.7854,
     1             4.3304,  4.1667,  4.0029,  3.8949,  3.7928,
     1             3.7443,  3.7090,  3.6632,  3.6230/
      data gscaleJapIt     /
     1             1.281752,  1.281752,  1.276927,  1.276432,  1.276923,  1.265210,
     1             1.217216,  1.169973,  1.161510,  1.171001,  1.178526,
     1             1.184540,  1.186356,  1.184606,  1.185796,  1.215778,
     1             1.301371,  1.416221,  1.786270,  2.049840,  2.154466,
     1             2.150556,  2.151376,  2.161172,  2.162603/
      data gscaleWen     /
     1             0.677079,  0.677079,  0.673024,  0.671230,  0.670425,  0.670146,
     1             0.669435,  0.664965,  0.658557,  0.646074,  0.637167,
     1             0.623973,  0.603607,  0.584897,  0.549356,  0.515582,
     1             0.442912,  0.388603,  0.331534,  0.000000,  0.000000,
     1             0.000000,  0.000000,  0.000000,  0.000000/
      data phi1    /
     1               0.8700,  0.8700,  0.8700,  0.8700,  0.8700,  0.8700,
     1               0.8700,  0.8700,  0.8700,  0.8700,  0.8700,
     1               0.8700,  0.8652,  0.8434,  0.7698,  0.7263,
     1               0.7360,  0.7960,  0.9023,  1.0001,  1.1271,
     1               1.0779,  0.8618,  0.5114,  0.4530/
      data phi1a   /
     1             660.6864,660.6864,660.5587,660.3290,659.9916,659.5425,
     1             657.9160,655.5663,653.1736,648.7759,645.3512,
     1             639.5540,628.4873,616.2557,590.7750,566.8623,
     1             522.1539,496.2030,472.2639,462.7207,455.6782,
     1             453.2343,452.1290,451.0754,450.7240/
      data phi1b   /
     1               3.0000,  3.0000,  3.0000,  3.0000,  3.0000,  3.0000,
     1               3.0050,  3.3600,  4.0620,  4.9290,  5.2620,
     1               5.5530,  5.8540,  6.0610,  6.2920,  6.3790,
     1               6.3600,  6.2200,  5.7160,  4.9520,  3.3470,
     1               3.0000,  2.9800,  3.0000,  3.0000/
      data phi2    /
     1             0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1             0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1             0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1             0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1             0.0000,  0.0000,  0.0000,  0.0000/
      data phi3    /
     1             -0.007010,-0.007010,-0.007279,-0.007354,-0.006977,-0.006467,
     1             -0.005734,-0.005604,-0.005696,-0.005845,-0.005959,
     1             -0.006141,-0.006439,-0.006704,-0.007125,-0.007435,
     1             -0.008120,-0.008444,-0.007707,-0.004792,-0.001828,
     1             -0.001523,-0.001440,-0.001369,-0.001361/
      data phi4    /
     1              0.102151, 0.102151, 0.108360, 0.119888, 0.133641, 0.148927,
     1              0.190596, 0.230662, 0.253169, 0.266468, 0.265060,
     1              0.255253, 0.231541, 0.207277, 0.165464, 0.133828,
     1              0.085153, 0.058595, 0.031787, 0.019716, 0.009643,
     1              0.005379, 0.003223, 0.001134, 0.000515/
      data phi5    /
     1               0.0000,  0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1               0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1               0.0000,  0.0000,  0.0000,  0.0000,  0.0000,
     1               0.0460,  0.1100,  0.1990,  0.2600,  0.3120,
     1               0.3020,  0.2540,  0.1540,  0.0860/
      data phi6    /
     1              300.00, 300.00, 300.00, 300.00, 300.00, 300.00,
     1              300.00, 300.00, 300.00, 300.00, 300.00,
     1              300.00, 300.00, 300.00, 300.00, 300.00,
     1              300.00, 300.00, 300.00, 300.00, 300.00,
     1              300.00, 300.00, 300.00, 300.00/
      data phi1Jp  /
     1               0.7780,  0.7780,  0.7598,  0.7062,  0.6572,  0.6389,
     1               0.7371,  0.8740,  0.9769,  1.1222,  1.2109,
     1               1.3421,  1.5379,  1.6771,  1.7600,  1.7310,
     1               1.4999,  1.2900,  1.0539,  0.9199,  0.7245,
     1               0.5703,  0.4228,  0.1259,  0.0448/
      data phi1aJp /
     1             460.5000,460.5000,461.9000,461.3288,460.4794,459.9103,
     1             460.5506,461.7000,459.8409,451.6690,443.1147,
     1             427.7425,399.7592,373.9212,340.0498,336.1073,
     1             391.7776,435.5000,454.1437,455.7000,454.4288,
     1             453.4794,453.4000,454.3506,454.6000/
      data phi1bJp /
     1               3.0000,  3.0000,  3.0000,  3.0000,  3.0000,  3.0000,
     1               2.9950,  2.9400,  2.8420,  2.6520,  2.4780,
     1               2.1550,  1.6980,  1.4360,  1.2060,  1.1400,
     1               1.3700,  1.6000,  2.0880,  2.4220,  2.8240,
     1               2.9900,  3.0000,  3.0000,  3.0000/
      data phi5Jp  /
     1               0.4770,  0.4770,  0.4730,  0.4680,  0.4620,  0.4580,
     1               0.4510,  0.4480,  0.4470,  0.4450,  0.4450,
     1               0.4440,  0.4450,  0.4470,  0.4560,  0.4700,
     1               0.5210,  0.5910,  0.7570,  0.9240,  1.1570,
     1               1.2600,  1.2400,  0.8540,  0.4160/
      data phi6Jp  /
     1              800.0000,800.0000,800.0000,800.0000,800.0000,800.0000,
     1              800.0000,800.0000,800.0000,800.0000,800.0000,
     1              800.0000,800.0000,800.0000,800.0000,800.0000,
     1              800.0000,800.0000,800.0000,800.0000,800.0000,
     1              800.0000,800.0000,800.0000,800.0000/
      data phi1Tw  /
     1               0.2000,  0.2000,  0.2000,  0.2000,  0.2000,  0.2000,
     1               0.2000,  0.2000,  0.2000,  0.2000,  0.2000,
     1               0.2000,  0.2000,  0.2000,  0.2000,  0.2000,
     1               0.2000,  0.2000,  0.2140,  0.3285,  0.6632,
     1               0.8428,  0.7903,  0.4874,  0.2660/
      data tau1    /
     1               0.4200,  0.4200,  0.4230,  0.4271,  0.4309,  0.4341,
     1               0.4404,  0.4450,  0.4479,  0.4514,  0.4533,
     1               0.4558,  0.4590,  0.4615,  0.4652,  0.4679,
     1               0.4724,  0.4753,  0.4788,  0.4811,  0.4838,
     1               0.4856,  0.4868,  0.4887,  0.4899/
      data tau2    /
     1               0.3300,  0.3300,  0.3289,  0.3273,  0.3259,  0.3247,
     1               0.3223,  0.3206,  0.3195,  0.3182,  0.3175,
     1               0.3166,  0.3154,  0.3144,  0.3130,  0.3120,
     1               0.3103,  0.3093,  0.3079,  0.3071,  0.3061,
     1               0.3054,  0.3050,  0.3042,  0.3038/
      data sigma1  /
     1               0.4912,  0.4912,  0.4904,  0.4988,  0.5049,  0.5096,
     1               0.5179,  0.5236,  0.5221,  0.5202,  0.5191,
     1               0.5177,  0.5159,  0.5143,  0.5119,  0.5100,
     1               0.4973,  0.4882,  0.4755,  0.4681,  0.4617,
     1               0.4571,  0.4535,  0.4471,  0.4426/
      data sigma2  /
     1               0.3762,  0.3762,  0.3762,  0.3849,  0.3910,  0.3957,
     1               0.4043,  0.4104,  0.4109,  0.4116,  0.4119,
     1               0.4124,  0.4130,  0.4135,  0.4144,  0.4150,
     1               0.4256,  0.4331,  0.4436,  0.4511,  0.4617,
     1               0.4571,  0.4535,  0.4471,  0.4426/
      data sigma3  /
     1               0.8000,  0.8000,  0.8000,  0.8000,  0.8000,  0.8000,
     1               0.8000,  0.8000,  0.8000,  0.8000,  0.8000,
     1               0.8000,  0.7999,  0.7997,  0.7988,  0.7966,
     1               0.7792,  0.7504,  0.7136,  0.7035,  0.7006,
     1               0.7001,  0.7000,  0.7000,  0.7000/


C Find the requested spectral period and corresponding coefficients
      nPer = 25
C First check for the PGA case (i.e., specT=0.0) 
      if (specT .eq. 0.0) then
         period1  = period(1)
         c1T      = c1(1)
         c1aT     = c1a(1)
         c1bT     = c1b(1)
         c1cT     = c1c(1)
         c1dT     = c1d(1)
         c3T      = c3(1)
         cHMT     = CHM(1)
         cnT      = cn(1)
         cmT      = cm(1)
         c5T      = c5(1)
         c6T      = c6(1)
         c7T      = c7(1) 
         c7bT      = c7b(1) 
         c8bT      = c8b(1)
         c9T      = c9(1)
         c9aT      = c9a(1)
         c9bT      = c9b(1)
         c11T      = c11(1)
         c11bT      = c11b(1)
         gamma1T  = gamma1(1)
         gamma2T  = gamma2(1)
         gmT      = gm(1)
         phi1T    = phi1(1)
         phi2T    = phi2(1)
         phi3T    = phi3(1)
         phi4T    = phi4(1)
         phi5T    = phi5(1)
         phi6T    = phi6(1)
         tau1T    = tau1(1)
         tau2T    = tau2(1)
         sigma1T = sigma1(1)
         sigma2T = sigma2(1)
         sigma2JapT = sigma2Jap(1)
         sigma3T = sigma3(1)
         gscaleJapItT = gscaleJapIt(1)
         gscaleWenT = gscaleWen(1)

         phi1aT = phi1a(1)
         phi1bT = phi1b(1)
         phi1JPT = phi1JP(1)
         phi1aJPT = phi1aJP(1)
         phi1bJPT = phi1bJP(1)
         phi5JPT = phi5JP(1)
         phi6JPT = phi6JP(1)
         phi1TWT = phi1TW(1)

         goto 1011
      elseif (specT .gt. 0.0) then
C Now loop over the spectral period range of the attenuation relationship.
         do i=2,nper-1
            if (specT .ge. period(i) .and. specT .le. period(i+1) ) then
               count1 = i
               count2 = i+1
               goto 1020 
            endif
         enddo
      endif

C Selected spectral period is outside range defined by attenuaton model.
      write (*,*) 
      write (*,*) 'Chiou and Youngs (NGA West2-2013) Vertical'
      write (*,*) 'attenuation model is not defined for a '
      write (*,*) ' spectral period of: ' 
      write (*,'(a10,f10.5)') ' Period = ',specT
      write (*,*) 'This spectral period is outside the defined'
      write (*,*) 'period range in the code or beyond the range'
      write (*,*) 'of spectral periods for interpolation.'
      write (*,*) 'Please check the input file.'
      write (*,*) 
      stop 99

C Interpolate the coefficients for the requested spectral period.
 1020       call interp (period(count1),period(count2),c1(count1),c1(count2),
     +                   specT,c1T,iflag)
            call interp (period(count1),period(count2),c1a(count1),c1a(count2),
     +                   specT,c1aT,iflag)
            call interp (period(count1),period(count2),c1b(count1),c1b(count2),
     +                   specT,c1bT,iflag)
            call interp (period(count1),period(count2),c1c(count1),c1c(count2),
     +                   specT,c1cT,iflag)
            call interp (period(count1),period(count2),c1d(count1),c1d(count2),
     +                   specT,c1dT,iflag)
            call interp (period(count1),period(count2),cn(count1),cn(count2),
     +                   specT,cnT,iflag)
            call interp (period(count1),period(count2),cm(count1),cm(count2),
     +                   specT,cmT,iflag)
            call interp (period(count1),period(count2),cHM(count1),cHM(count2),
     +                   specT,cHMT,iflag)
            call interp (period(count1),period(count2),c3(count1),c3(count2),
     +                   specT,c3T,iflag)
            call interp (period(count1),period(count2),c5(count1),c5(count2),
     +                   specT,c5T,iflag)
            call interp (period(count1),period(count2),c6(count1),c6(count2),
     +                   specT,c6T,iflag)
            call interp (period(count1),period(count2),c7(count1),c7(count2),
     +                   specT,c7T,iflag)
            call interp (period(count1),period(count2),c7b(count1),c7b(count2),
     +                   specT,c7bT,iflag)
            call interp (period(count1),period(count2),c8b(count1),c8b(count2),
     +                   specT,c8bT,iflag)
            call interp (period(count1),period(count2),c9(count1),c9(count2),
     +                   specT,c9T,iflag)
            call interp (period(count1),period(count2),c9a(count1),c9a(count2),
     +                   specT,c9aT,iflag)
            call interp (period(count1),period(count2),c9b(count1),c9b(count2),
     +                   specT,c9bT,iflag)
            call interp (period(count1),period(count2),c11(count1),c11(count2),
     +                   specT,c11T,iflag)
            call interp (period(count1),period(count2),c11b(count1),c11b(count2),
     +                   specT,c11bT,iflag)
            call interp (period(count1),period(count2),gamma1(count1),gamma1(count2),
     +                   specT,gamma1T,iflag)
            call interp (period(count1),period(count2),gamma2(count1),gamma2(count2),
     +                   specT,gamma2T,iflag)
            call interp (period(count1),period(count2),gm(count1),gm(count2),
     +                   specT,gmT,iflag)
            call interp (period(count1),period(count2),phi1(count1),phi1(count2),
     +                   specT,phi1T,iflag)
            call interp (period(count1),period(count2),phi2(count1),phi2(count2),
     +                   specT,phi2T,iflag)
            call interp (period(count1),period(count2),phi3(count1),phi3(count2),
     +                   specT,phi3T,iflag)
            call interp (period(count1),period(count2),phi4(count1),phi4(count2),
     +                   specT,phi4T,iflag)
            call interp (period(count1),period(count2),phi5(count1),phi5(count2),
     +                   specT,phi5T,iflag)
            call interp (period(count1),period(count2),phi6(count1),phi6(count2),
     +                   specT,phi6T,iflag)
            call interp (period(count1),period(count2),tau1(count1),tau1(count2),
     +                   specT,tau1T,iflag)
            call interp (period(count1),period(count2),tau2(count1),tau2(count2),
     +                   specT,tau2T,iflag)
            call interp (period(count1),period(count2),sigma1(count1),sigma1(count2),
     +                   specT,sigma1T,iflag)
            call interp (period(count1),period(count2),sigma2(count1),sigma2(count2),
     +                   specT,sigma2T,iflag)
            call interp (period(count1),period(count2),sigma2Jap(count1),sigma2Jap(count2),
     +                   specT,sigma2JapT,iflag)
            call interp (period(count1),period(count2),sigma3(count1),sigma3(count2),
     +                   specT,sigma3T,iflag)
            call interp (period(count1),period(count2),gscaleJapIt(count1),gscaleJapIt(count2),
     +                   specT,gscaleJapItT,iflag)
            call interp (period(count1),period(count2),gscaleWen(count1),gscaleWen(count2),
     +                   specT,gscaleWenT,iflag)

            call interp (period(count1),period(count2),phi1a(count1),phi1a(count2),
     +                   specT,phi1aT,iflag)
            call interp (period(count1),period(count2),phi1b(count1),phi1b(count2),
     +                   specT,phi1bT,iflag)
            call interp (period(count1),period(count2),phi1JP(count1),phi1JP(count2),
     +                   specT,phi1JPT,iflag)
            call interp (period(count1),period(count2),phi1aJP(count1),phi1aJP(count2),
     +                   specT,phi1aJPT,iflag)
            call interp (period(count1),period(count2),phi1bJP(count1),phi1bJP(count2),
     +                   specT,phi1bJPT,iflag)
            call interp (period(count1),period(count2),phi5JP(count1),phi5JP(count2),
     +                   specT,phi5JPT,iflag)
            call interp (period(count1),period(count2),phi6JP(count1),phi6JP(count2),
     +                   specT,phi6JPT,iflag)
            call interp (period(count1),period(count2),phi1TW(count1),phi1TW(count2),
     +                   specT,phi1TWT,iflag)

 1011 period1 = specT                                                                                                              

c     Set the fault mechanism term.
C     fType     Mechanism                      Rake
C     ------------------------------------------------------
C      -1       Normal                   -120 < Rake < -60.0
C     1, 0.5    Reverse and Rev/Obl        30 < Rake < 150.0
C     0,-0.5    Strike-Slip and NMl/Obl        Otherwise
         if (ftype .eq. -1) then
            F_RV = 0.0
            F_NM = 1.0
         elseif (ftype .ge. 0.5) then
            F_RV = 1.0
            F_NM = 0.0
         else
            F_RV = 0.0
            F_NM = 0.0
         endif

C     Constant terms
        c2 = 1.06
        c4 = -2.1
        c4a = -0.5
        cRB = 50.0
        c8 = 0.2154
        c8a = 0.0

        pi = atan(1.0)*4.0
        d2r = pi/180.0

        cc = c5T* cosh(c6T * max((M-cHMT),0.0))
        gamma = gamma1T + gamma2T/cosh(max((M-gmT),0.0))
C     Apply Regional scaling factor.
C     Regionflag = 0 Global
C     Regionflag = 1 Japan and Italy
C        Also set sigma2 equal to Japan specific value
C     Regionflag = 2 Wenchuan (note only for M7.9)
        if (regionflag .eq. 1 ) then
           gamma = gamma * gscaleJapItT
           sigma2T = sigma2JapT
        elseif (regionflag .eq. 2) then
           gamma = gamma * gscaleWenT        
        endif

        cosDELTA = cos(abs(DELTA)*d2r)

c Magnitude scaling
        r1 = c1T + c2 * (M-6.0) +
     1       (c2-c3T)/cnT *
     1             alog(1.0 + exp(cnT*(cMT-M)))

c Near-field magnitude and distance scaling
        r2 = c4 * alog(Rrup + cc)

c Distance scaling at large distance
        r3 = (c4a-c4)/2.0 *
     1            alog( Rrup*Rrup+cRB*cRB ) +
     1       Rrup * gamma

c Center Z_TOR on the Z_TOR-M relation in Chiou and Youngs (2013)
        if (F_RV.EQ.1) then
          if (M .le. 5.849) then
              mZ_TOR = 2.704*2.704
          else
              mZ_TOR = max(2.704-1.226*(M-5.849), 0.0)
              mZ_TOR = mZ_TOR * mZ_TOR
          endif
        else
          if (M .le. 4.970) then
              mZ_TOR = 2.673*2.673
          else
              mZ_TOR = max(2.673-1.136*(M-4.970), 0.0)
              mZ_TOR = mZ_TOR * mZ_TOR
          endif
        endif
c        if (Z_TOR .EQ. -999) Z_TOR = mZ_TOR
        deltaZ_TOR = Dtor - mZ_TOR

c Scaling with other source variables (F_RV, F_NM, deltaZ_TOR, and Dip)
        coshM = cosh(2*max(M-4.5,0.0))
        cosDELTA = cos(DELTA*d2r)
        r4 = (c1aT+c1cT/coshM) * F_RV +
     1       (c1bT+c1dT/coshM) * F_NM +
     1       (c7T +c7bT/coshM) * deltaZ_TOR +
     1       (c11T+c11bT/coshM)* cosDELTA**2

C New Dip dependence for NGA West2 Model
c        if (m .lt. 6.0) then
c           r4 = r4 + c11T*min(delta-70.0,0.0)
c        endif
        
c HW effect
        if (HWFlag .eq. 0) then
           hw = 0.0
        else
         hw = c9T * (cosDELTA) * (c9aT+(1-c9aT)
     1        *tanh(Rx/c9bT)) *
     1          (1.0 - sqrt(Rbjf**2+DTor**2)/(Rrup + 1))
        endif

C     Current version of the code sets cDPP=0 (i.e., no directivity)
c Directivity effect
c        cDPP = 0.0
c        fd = c8T * exp(-c8aT * (M-c8bT)**2) *
c     1       max(0.0, 1.0-max(0.0,Rrup-40.0)/30.0) *
c     1       min(max(0.0,M-5.5)/0.8, 1.0) * cDPP
        fd= 0.0
c Predicted median Sa on reference condition (Vs=1130 m/sec)
        psa_ref = r1+r2+r3+r4+hw+fd
       
c Linear soil amplification
c        a = phi1T * min(alog(Vs/1130.0), 0.0)
C     Vertical Linear Amp Function
         a = phi1T / (1 + (vs/phi1aT)**phi1bT)

c Nonlinear soil amplification
        b = phi2T *
     1      (exp(phi3T*(min(Vs,1130.0)-360.0)) - exp(phi3T*(1130.0-360.0)))
        c = phi4T

C Deviation from ln(Vs30) scaling: bedrock depth (Z1) effect.
        deltaZ1 = depthvs10*1000.0 -
c     1  exp(-7.15/4.0 * log((VS**4.0 + 570.94**4.0)/(1360.0**4.0 + 570.94**4.0)))
     1  exp(-7.15/4.0 * alog((VS**4.0 + 571.0**4.0)/(1360.0**4.0 + 571.0**4.0)))

        rkdepth = phi5T * ( 1.0 - exp(-deltaZ1/phi6T ) )

c Sa on soil condition
c        psa = psa_ref + (a + b * alog((exp(psa_ref)+c)/c)) + rkdepth
        psa = psa_ref + a + rkdepth


C Compute the sigma term

c        NL0 = b * exp(psa_ref)/(exp(psa_ref)+c)

        tau = tau1T +
     1            (tau2T-tau1T)/1.5*(min(max(M,5.0),6.5)-5.0)
C     Current code set for Measured Vs30 values (i.e., Vs30class=1)
      if (vs30_class .eq. 0) then
         F_measured = 0.0
         F_Inferred = 1.0
      elseif (vs30_class .eq. 1) then      
         F_measured = 1.0
         F_Inferred = 0.0
      endif

        sigma_NL0 = (sigma1T +
     1              ( (sigma2T-sigma1T)/1.5*(min(max(M,5.0),6.5)-5.0))) *
     1         sqrt(0.7*F_Measured+F_Inferred*sigma3T+1.0) 

        sigma = sqrt((tau)**2.0+sigma_NL0**2.0)

      phi = sigma_NL0

C     Convert ground motion to units of gals.
      lnY = psa + 6.89
      period2 = period1

      return
      end 
  
c ------------------------------------------------------------------            
C *** Gulerce, Kamai, Abrahamson, and Silva (NGA-West2 2013) Vertical ****
C     Reference: 
C     Notes:
C        Applicable Range (see Abstract):  
C           3 <= M <= 8.5
C           Rrup <= 300 km
C        Regional attenuation included based on Regionflag
C             0 = Global
C             1 = Taiwan
C             2 = China
C             3 = Japan
C         Mainshock and Aftershocks included based on MSASFlag
C             0 = Mainshocks
C             1 = Aftershocks
C         Sigma dependent on estimated or measured Vs30m based on 
C             Vs30_Class
C             0 = Estimated Vs30m
C             1 = Measured Vs30m
c ------------------------------------------------------------------            
      subroutine GKAS_NGAWest2_2013_Vert ( mag, dip, fType, fltWidth, rRup, Rjb,  
     1                     vs30, hwflag, lnY, sigma, specT, period2, ztor,
     2                     iflag, vs30_class, z10, Rx, Ry0, regionflag, msasflag, phi, tau )

C     Last Updated: 6/03/14

      implicit none

      real mag, dip, fType, rRup, rjb, Rx, Ry0, vs30, SA1180,
     1      Z10,  ZTOR, fltWidth, lnSa, sigma, lnY, vs30_rock
      real Fn, Frv, specT, period2, CRjb, phi, tau, SA_rock, z10_rock
      integer hwflag, iflag, vs30_class, regionflag, msasflag

c     Vs30 class is to distinguish between the sigma if the Vs30 is measured
c     vs the VS30 being estimated from surface geology.
c         Vs30_class = 0 for estimated
c         Vs30_class = 1 for measured 

C     Current version is not programmed for Aftershock cases. 
C       For implementation of Aftershock a new distance metric, CRjb
C       will need to be computed and passed along to this subroutine. 

      CRjb = 999.9 

C     Set mechanism term and corresponding Frv and Fnm values.    
C     fType     Mechanism                      Rake
C     ------------------------------------------------------
C      -1       Normal                   -120 < Rake < -60.0
C     1, 0.5    Reverse and Rev/Obl        30 < Rake < 150.0
C     0,-0.5    Strike-Slip and NMl/Obl        Otherwise
C 
      if ( fType .eq. 1.0 ) then
        Frv = 1.0
        Fn = 0.0
      elseif ( fType .eq. 0.5 ) then
        Frv = 1.0
        Fn = 0.0
      elseif ( fType .eq. -1.0 ) then
        Frv = 0.0
        Fn = 1.0
      elseif ( fType .eq. -0.5 ) then
        Frv = 0.0
        Fn = 1.0
      else
        Frv = 0.0
        Fn = 0.0
      endif

c     Compute SA1180
      vs30_rock = 1180.
      z10_rock = 0.005
      SA_rock = 0.
      
      call GKAS2013_v11_model_Vert ( mag, dip, fltWidth, ZTOR, Frv, Fn, rRup, rjb, rx, Ry0, 
     1                     vs30_rock, SA_rock, Z10_rock, hwflag, vs30_class,
     2                     specT, lnSa, phi, tau, iflag, regionflag, msasflag, CRjb )
      Sa1180 = exp(lnSa)

c     Compute Sa at spectral period for given Vs30

      call GKAS2013_v11_model_Vert ( mag, dip, fltWidth, ZTOR, Frv, Fn, rRup, rjb, rx, Ry0, 
     1                     vs30, SA1180, Z10, hwflag, vs30_class,
     2                     specT, lnSa, phi, tau, iflag, regionflag, msasflag, CRjb )

c     compute Sa (given the PGA rock value)
      sigma = sqrt( phi**2 + tau**2 )

      lnY = lnSa + 6.89

      period2 = specT

      return
      end

c ----------------------------------------------------------------------
      subroutine GKAS2013_v11_model_Vert ( mag, dip, FltWidth, ZTOR, Frv, Fn, rRup, rjb, Rx, Ry0, 
     1                     vs30, Sa1180, Z1, hwflag, vs30_class,
     3                     specT, lnSa, phi, tau, iflag, regionflag, msasflag, CRjb)
 
      implicit none
      
      integer MAXPER, i     
      parameter (MAXPER=24)
      
      real Vlin(MAXPER), b(MAXPER), c4(MAXPER), M1(MAXPER), a1(MAXPER)
      real a2(MAXPER), a3(MAXPER), a6(MAXPER), a8(MAXPER), a10(MAXPER)
      real a11(MAXPER), a12(MAXPER), a13(MAXPER), a14(MAXPER), a15(MAXPER)
      real a17(MAXPER), a43(MAXPER), a44(MAXPER), a45(MAXPER), a46(MAXPER)
      real a25(MAXPER), a28(MAXPER), a29(MAXPER), a31(MAXPER), a36(MAXPER)
      real a37(MAXPER), a38(MAXPER), a39(MAXPER), a40(MAXPER), a41(MAXPER), a42(MAXPER)
      real s1est(MAXPER), s2est(MAXPER), s1msr(MAXPER), s2msr(MAXPER)
      real s3(MAXPER), s4(MAXPER), s5(MAXPER), s6(MAXPER), period(MAXPER)
      real c(MAXPER), a4(MAXPER)
      real a5(MAXPER), a5T, a7
      real VlinT, bT, c4T, M1T, a1T
      real a2T, a3T, a6T, a8T, a10T
      real a11T, a12T, a13T, a14T, a15T
      real a17T, a43T, a44T, a45T, a46T
      real a25T, a28T, a29T, a31T, a36T
      real a37T, a38T, a39T, a40T, a41T, a42T
      real s1estT, s2estT, s1msrT, s2msrT
      real s3T, s4T, s5T, s6T, c4_mag
      real phiA_est, phiA_msr
      real cT, a4T
      
      real M2, period1, z1_ref
      real lnSa, SA1180, rjb, rRup, Rx, Ry0, dip, mag, vs30
      real HW_taper1, HW_taper2, HW_taper3, HW_taper4, HW_taper5
      real damp_dSA1180, sigAmp, fltWidth
      real f1, f4, f5, f6, f7, f8, f9, f10, f11, fReg, f12, f13
      real ZTOR, Frv, Fn, SpecT
      real phiA, phiB, tauA, tauB, phi, tau
      integer vs30_class, hwflag, iflag, nPer, regionflag, msasflag
      real n, z1
      real R, V1, Vs30Star, hw_a2, h1, h2, h3, R1, R2, CRjb
      integer count1, count2
      real y1, y2, x1, x2, y1z, y2z, x1z, x2z

      Data Period  /  0, -1, 0.01, 0.02, 0.03, 0.05, 0.075, 0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.5, 
     1                0.75, 1, 1.5, 2, 3, 4, 5, 6, 7.5, 10  / 

      
      Data VLIN  /  660, 330, 660, 680, 770, 800, 800, 800, 740, 590, 495, 430, 360, 340, 330, 
     1         330, 330, 330, 330, 330, 330, 330, 330, 330  / 
      Data b  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      
      Data c  /  2.4, 2400, 2.4, 2.4, 2.4, 2.4, 2.4, 2.4, 2.4, 2.4, 2.4, 1.8, 1.8, 1.8, 1.8,
     1         1.8, 1.8, 1.8, 1.8, 1.8, 1.8, 1.8, 1.8, 1.8  / 
      Data c4  / 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8  / 

      Data a1  /  1.8892, 5.0635, 1.8892, 2.1323, 2.4756, 2.9551, 2.9285, 2.7345, 2.4477, 2.221, 2.0704, 
     1        1.9744, 1.8231, 1.7434, 1.6445, 1.5417, 1.1339, 0.9542, 0.6368, 0.3567, 0.1143, -0.1242, 
     1       -0.5314, -1.2361  / 
      Data a2  /  -1.322, -0.85, -1.322, -1.37, -1.418, -1.43, -1.355, -1.3, -1.24, -1.205, -1.175, 
     1       -1.16, -1.13, -1.13, -1.13, -1.13, -1.085, -1.053, -1.008, -0.977, -0.952, -0.932, 
     1       -0.9075, -0.875  / 
      Data a3  /  0.385, 0.3524, 0.385, 0.385, 0.385, 0.385, 0.385, 0.385, 0.35, 0.326, 0.307, 
     1        0.291, 0.267, 0.248, 0.213, 0.188, 0.154, 0.129, 0.095, 0.07, 0.07, 0.07, 0.07, 0.07  / 
      Data a4  /  -0.106, -0.27, -0.106, -0.106, -0.106, -0.106, -0.106, -0.106, -0.106, -0.106,
     1       -0.106, -0.106, -0.106, -0.106, -0.106, -0.106, -0.106, -0.106, -0.106, -0.106, -0.106,
     1       -0.106, -0.106, -0.106 / 
      Data a5  /  -0.801, -0.4414, -0.801, -0.801, -0.801, -0.801, -0.801, -0.801, -0.801, 
     1       -0.801, -0.801, -0.801, -0.801, -0.801, -0.801, -0.801, -0.801, -0.801, -0.801, 
     1       -0.801, -0.801, -0.801, -0.801, -0.801 / 
      Data a6  /  1.75, 2.6, 1.75, 1.75, 1.75, 1.75, 1.75, 1.75, 1.937, 2.069, 2.172, 2.256, 2.388, 
     1        2.491, 2.678, 2.81, 2.81, 2.81, 2.81, 2.81, 2.81, 2.81, 2.81, 2.81  / 
      Data a8  /  0, -0.11, 0, 0, 0, 0, 0, 0, -0.0127, -0.0297, -0.0452, -0.0556, -0.0811, -0.1001,
     1       -0.1451, -0.1795, -0.236, -0.2897, -0.3629, -0.41, -0.44, -0.455, -0.4618, -0.4657  / 
      Data M1  /  6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 
     1        6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75, 6.75  / 
      Data a10  /  -0.1627, -0.3, -0.1627, -0.1627, -0.1627, -0.1627, -0.1627, -0.1627, -0.1627,
     1       -0.1627, -0.1627, -0.1627, -0.1627, -0.1627, -0.1627, -0.1627, -0.1627, -0.1627, 
     1       -0.1627, -0.1627, -0.1627, -0.1627, -0.1627, -0.1627  / 
      Data a11  /  -0.22, 0, -0.22, -0.22, -0.22, -0.22, -0.22, -0.22, -0.1672, -0.1297, -0.1006,
     1       -0.0769, -0.0394, -0.0103, 0.0425, 0.08, 0.1328, 0.1703, 0.2231, 0.2606, 0.2897, 
     1        0.3134, 0.3422, 0.38  / 
      Data a12  /  -0.1, 0, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1,
     1       -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1, -0.1  / 
      Data a13  /  0.67, 0.35, 0.67, 0.67, 0.67, 0.67, 0.67, 0.67, 0.67, 0.67, 0.62, 0.579, 0.515,
     1        0.465, 0.374, 0.31, 0.219, 0.155, 0.064, 0, 0, 0, 0, 0  / 
      Data a14  / 0, 0.1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a15  /  1.05, 0.85, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 1.05, 0.9734,
     1        0.8525, 0.7588, 0.5884, 0.4675, 0.2971, 0.1763, 0.0059, -0.115, -0.2088, 
     1       -0.2854, -0.37815, -0.5  / 
      Data a17  /  -0.0005, 0, -0.0005, -0.0005, -0.0009, -0.0022, -0.0026, -0.0021, -0.0012,
     1       -0.0002, -0.0002, -0.0002, -0.0002, -0.0002, -0.0002, -0.0002, -0.0002, -0.0002,
     1       -0.0002, -0.0002, -0.0002, -0.0002, -0.0002, -0.0002  / 
      Data a25  /  -0.0022, 0, -0.0022, -0.0023, -0.0022, -0.003, -0.0055, -0.0063, -0.0056, 
     1       -0.0052, -0.0041, -0.0033, -0.0019, -0.0011, -0.0008, -0.0008, -0.0008, -0.0008,
     1       -0.0008, -0.0008, -0.0008, -0.0008, -0.0008, -0.0008  / 
      Data a28  /  -0.0007, 0, -0.0007, -0.0008, -0.0007, -0.0004, -0.0003, -0.0007, -0.0006,
     1       -0.0004, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a29  /  -0.0036, 0, -0.0036, -0.0037, -0.0036, -0.004, -0.0044, -0.0049, -0.0051, 
     1       -0.0053, -0.0049, -0.0044, -0.0037, -0.0031, -0.0022, -0.0016, -0.0012, -0.0012,
     1       -0.0012, -0.0012, -0.0012, -0.0012, -0.0012, -0.0012  / 
      Data a31  /  -0.033, 0, -0.033, -0.033, -0.033, -0.033, -0.033, -0.033, -0.033, -0.033,
     1       -0.033, -0.033, -0.033, -0.033, -0.033, -0.033, -0.033, -0.033, -0.033, -0.033, 
     1       -0.033, -0.033, -0.033, -0.033  / 
      Data a36  /  1.32, 0, 1.32, 1.32, 1.32, 1.32, 1.32, 1.32, 1.0737, 0.8989, 0.7633, 
     1        0.6526, 0.4778, 0.3422, 0.0959, -0.0789, -0.3252, -0.5, -0.5, -0.5, -0.5, 
     1       -0.5, -0.5, -0.5  / 
      Data a37  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a38  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a39  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a40  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a41  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a42  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a43  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a44  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a45  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
      Data a46  / 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0  / 
C     Set Measure S1 and S2 values equal to estimated values.
      Data s1est  /  0.72, 0.5893, 0.72, 0.72, 0.72, 0.72, 0.72, 0.72, 0.72, 0.697848887, 0.680667149,
     1       0.666628647, 0.644477534, 0.627295796, 0.596075556, 0.573924444, 0.542704204, 0.520553091, 
     1       0.489332851, 0.467181738, 0.45, 0.435961498, 0.419, 0.397  / 
      Data s2est  /  0.57, 0.466, 0.57, 0.5910721, 0.603398488, 0.6189279, 0.631254288, 0.64, 0.6395,
     1       0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395,
     1       0.6395, 0.6395, 0.6395, 0.6395  / 
      Data s1msr  /  0.72, 0.5893, 0.72, 0.72, 0.72, 0.72, 0.72, 0.72, 0.72, 0.697848887, 0.680667149,
     1       0.666628647, 0.644477534, 0.627295796, 0.596075556, 0.573924444, 0.542704204, 0.520553091,
     1       0.489332851, 0.467181738, 0.45, 0.435961498, 0.419, 0.397  / 
      Data s2msr  /  0.57, 0.466, 0.57, 0.5910721, 0.603398488, 0.6189279, 0.631254288, 0.64, 0.6395,
     1       0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 0.6395, 
     1       0.6395, 0.6395, 0.6395, 0.6395  / 
      Data s3  /  0.49, 0.4949, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 
     1       0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49, 0.49  / 
      Data s4  /  0.315, 0.2402, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315,
     1       0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315, 0.315  / 
 

      
C Find the requested spectral period and corresponding coefficients
      nPer = 24

C First check for the PGA, PGV, PGD cases 
      if (specT .eq. 0.0) then
         period1 = period(1)
         a1T = a1(1)
         a2T = a2(1)
         a3T = a3(1)
         a4T = a4(1)
         a5T = a5(1)
         a6T = a6(1)
         a8T = a8(1)
         M1T = M1(1)
         cT = c(1)
         a10T = a10(1)
         a11T = a11(1)
         a12T = a12(1)
         a13T = a13(1)
         a14T = a14(1)
         a15T = a15(1)
         a17T = a17(1)
         a43T = a43(1)
         a44T = a44(1)
         a45T = a45(1)
         a46T = a46(1)
         a25T = a25(1)
         a28T = a28(1)
         a29T = a29(1)
         a31T = a31(1)
         a36T = a36(1)
         a37T = a37(1)
         a38T = a38(1)
         a39T = a39(1)
         a40T = a40(1)
         a41T = a41(1)
         a42T = a42(1)
         VlinT = Vlin(1)
         bT = b(1)
         c4T = c4(1)
         s1estT = s1est(1)
         s2estT = s2est(1)
         s1msrT = s1msr(1)
         s2msrT = s2msr(1)
         s3T = s3(1)
         s4T = s4(1)
         s5T = s5(1)
         s6T = s6(1)
         goto 1011
      elseif (specT .eq. -1.0) then
         period1 = period(2)
         a1T = a1(2)
         a2T = a2(2)
         a3T = a3(2)
         a4T = a4(2)
         a5T = a5(2)
         a6T = a6(2)
         a8T = a8(2)
         M1T = M1(2)
         cT = c(2)
         a10T = a10(2)
         a11T = a11(2)
         a12T = a12(2)
         a13T = a13(2)
         a14T = a14(2)
         a15T = a15(2)
         a17T = a17(2)
         a43T = a43(2)
         a44T = a44(2)
         a45T = a45(2)
         a46T = a46(2)
         a25T = a25(2)
         a28T = a28(2)
         a29T = a29(2)
         a31T = a31(2)
         a36T = a36(2)
         a37T = a37(2)
         a38T = a38(2)
         a39T = a39(2)
         a40T = a40(2)
         a41T = a41(2)
         a42T = a42(2)
         VlinT = Vlin(2)
         bT = b(2)
         c4T = c4(2)
         s1estT = s1est(2)
         s2estT = s2est(2)
         s1msrT = s1msr(2)
         s2msrT = s2msr(2)
         s3T = s3(2)
         s4T = s4(2)
         s5T = s5(2)
         s6T = s6(2)
         goto 1011
      endif
C   For other periods, loop over the spectral period range of the attenuation relationship.
      do i=3,nper-1
         if (specT .ge. period(i) .and. specT .le. period(i+1) ) then
            count1 = i
            count2 = i+1
            goto 1020 
         endif
      enddo

C Selected spectral period is outside range defined by attenuaton model.
      write (*,*) 
      write (*,*) 'Gulerce, Kamai, Abrahamson, and Silva (NGA West2-2013) Vertical'
      write (*,*) 'attenuation model is not defined for a '
      write (*,*) ' spectral period of: ' 
      write (*,'(a10,f10.5)') ' Period = ',specT
      write (*,*) 'This spectral period is outside the defined'
      write (*,*) 'period range in the code or beyond the range'
      write (*,*) 'of spectral periods for interpolation.'
      write (*,*) 'Please check the input file.'
      write (*,*) 
      stop 99

C Interpolate the coefficients for the requested spectral period.
 1020       call interp (period(count1),period(count2),a1(count1),a1(count2),
     +                   specT,a1T,iflag)
            call interp (period(count1),period(count2),a2(count1),a2(count2),
     +                   specT,a2T,iflag)
            call interp (period(count1),period(count2),a3(count1),a3(count2),
     +                   specT,a3T,iflag)
            call interp (period(count1),period(count2),a4(count1),a4(count2),
     +                   specT,a4T,iflag)
            call interp (period(count1),period(count2),a5(count1),a5(count2),
     +                   specT,a5T,iflag)
            call interp (period(count1),period(count2),a6(count1),a6(count2),
     +                   specT,a6T,iflag)
            call interp (period(count1),period(count2),a8(count1),a8(count2),
     +                   specT,a8T,iflag)
            call interp (period(count1),period(count2),M1(count1),M1(count2),
     +                   specT,M1T,iflag)
            call interp (period(count1),period(count2),c(count1),c(count2),
     +                   specT,cT,iflag)
            call interp (period(count1),period(count2),a10(count1),a10(count2),
     +                   specT,a10T,iflag)
            call interp (period(count1),period(count2),a11(count1),a11(count2),
     +                   specT,a11T,iflag)
            call interp (period(count1),period(count2),a12(count1),a12(count2),
     +                   specT,a12T,iflag)
            call interp (period(count1),period(count2),a13(count1),a13(count2),
     +                   specT,a13T,iflag)
            call interp (period(count1),period(count2),a14(count1),a14(count2),
     +                   specT,a14T,iflag)
            call interp (period(count1),period(count2),a15(count1),a15(count2),
     +                   specT,a15T,iflag)
            call interp (period(count1),period(count2),a17(count1),a17(count2),
     +                   specT,a17T,iflag)
            call interp (period(count1),period(count2),a43(count1),a43(count2),
     +                   specT,a43T,iflag)
            call interp (period(count1),period(count2),a44(count1),a44(count2),
     +                   specT,a44T,iflag)
            call interp (period(count1),period(count2),a45(count1),a45(count2),
     +                   specT,a45T,iflag)
            call interp (period(count1),period(count2),a46(count1),a46(count2),
     +                   specT,a46T,iflag)
            call interp (period(count1),period(count2),a25(count1),a25(count2),
     +                   specT,a25T,iflag)
            call interp (period(count1),period(count2),a28(count1),a28(count2),
     +                   specT,a28T,iflag)
            call interp (period(count1),period(count2),a29(count1),a29(count2),
     +                   specT,a29T,iflag)
            call interp (period(count1),period(count2),a31(count1),a31(count2),
     +                   specT,a31T,iflag)
            call interp (period(count1),period(count2),a36(count1),a36(count2),
     +                   specT,a36T,iflag)
            call interp (period(count1),period(count2),a37(count1),a37(count2),
     +                   specT,a37T,iflag)
            call interp (period(count1),period(count2),a38(count1),a38(count2),
     +                   specT,a38T,iflag)
            call interp (period(count1),period(count2),a39(count1),a39(count2),
     +                   specT,a39T,iflag)
            call interp (period(count1),period(count2),a40(count1),a40(count2),
     +                   specT,a40T,iflag)
            call interp (period(count1),period(count2),a41(count1),a41(count2),
     +                   specT,a41T,iflag)
            call interp (period(count1),period(count2),a42(count1),a42(count2),
     +                   specT,a42T,iflag)
            call interp (period(count1),period(count2),Vlin(count1),Vlin(count2),
     +                   specT,VlinT,iflag)
            call interp (period(count1),period(count2),b(count1),b(count2),
     +                   specT,bT,iflag)
            call interp (period(count1),period(count2),c4(count1),c4(count2),
     +                   specT,c4T,iflag)
            call interp (period(count1),period(count2),s1est(count1),s1est(count2),
     +                   specT,s1estT,iflag)
            call interp (period(count1),period(count2),s2est(count1),s2est(count2),
     +                   specT,s2estT,iflag)
            call interp (period(count1),period(count2),s1msr(count1),s1msr(count2),
     +                   specT,s1msrT,iflag)
            call interp (period(count1),period(count2),s2msr(count1),s2msr(count2),
     +                   specT,s2msrT,iflag)
            call interp (period(count1),period(count2),s3(count1),s3(count2),
     +                   specT,s3T,iflag)
            call interp (period(count1),period(count2),s4(count1),s4(count2),
     +                   specT,s4T,iflag)
            call interp (period(count1),period(count2),s5(count1),s5(count2),
     +                   specT,s5T,iflag)
            call interp (period(count1),period(count2),s6(count1),s6(count2),
     +                   specT,s6T,iflag)

 1011 period1 = specT                                                                                                              

C     Constant values
      n = 1.5
      M2 = 5.0
      a7 = 0.0

C     Set C term
c      if (period1 .eq. -1.0) then
c         c = 2400.0
c      else
c         c = 2.4
c      endif

C     Magnitude dependent taper for C4 (eq. 4.4)
c      if (mag .ge. 5.0) then
c         c4_mag = c4T
c      elseif (mag .ge. 4.0) then
c         c4_mag = c4T - (c4T-1.0) * (5.0-mag)
c      else
c         c4_mag = 1.0
c      endif 
C     Set C4 for vertical model
      c4_mag = c4T     
c     Set distance (eq 4.3)
      R = sqrt(rRup**2 + c4_mag**2)
       	  
C     Base Model (eq 4.2)
      if ( mag .lt. M2 ) then
        f1 = a1T + a6T*(Mag-M2) + a7*(Mag-M2)**2 + a4T*(M2-M1T) + a8T*(8.5-M2)**2 +
     1                (a2T + a3T*(M2-M1T)) * alog(R) + a17T*R
      elseif ( mag .lt. M1T ) then
        f1 = a1T + a4T*(Mag-M1T) + a8T*(8.5-Mag)**2 + (a2T + a3T*(Mag-M1T)) * alog(R) + a17T*Rrup
      else
        f1 = a1T + a5T*(Mag-M1T) + a8T*(8.5-Mag)**2 + (a2T + a3T*(Mag-M1T)) * alog(R) + a17T*Rrup
      endif

c     style of faulting (eq 4.5 and 4.6) 
      if ( mag .lt. 4. ) then
        f7 = 0
        f8 = 0
      elseif ( mag .le. 5. ) then
        f7 = Frv * a11T * (mag-4.)
        f8 = Fn * a12T * (mag-4.)
      else 
        f7 = Frv * a11T
        f8 = Fn * a12T
      endif

c     ZTOR (eq 14) - vertical is set at 12 km
      if (ZTOR .le. 12.) then 
        f6 = a15T * ZTOR/12.0
      else
        f6 = a15T
      endif    

c     Set VS30_star (eq 4.8 and 4.9)
      if ( specT .ge. 3.0 ) then
        V1 = 800.
      elseif ( specT .gt. 0.5 ) then
        V1 = exp( -0.35 * alog(specT/0.5)  + alog(1500.) )
      else
        V1=1500.
      endif
      if ( vs30 .lt. v1 ) then
         vs30Star = vs30
      else
	vs30Star = v1
      endif		

c     Compute site amplification (Eq. 4.7)  
      if (vs30 .lt. vLinT) then
        f5 = a10T*alog(vs30Star/vLinT) - bT*alog(cT+Sa1180) 
     1              + bT*alog(Sa1180+cT*((vs30Star/vLinT)**(n)) )
      else
     	f5 = (a10T + bT*n) * alog(vs30Star/vLinT)
      endif

c     Set Regional z1 reference (eq 4.18)
      if (regionflag .ne. 3) then
         z1_ref = exp ( -7.67/4. * alog( (Vs30**4 + 610.**4)/(1360.**4+610.**4) ) ) / 1000.
      else
         z1_ref = exp ( -5.23/2. * alog( (Vs30**4 + 412.**2)/(1360.**2+412.**2) ) ) / 1000.
      endif 
      
C     Soil Depth Model (eq 4.17)
C     Updated 8/1/13
      if ( vs30 .le. 150.0 ) then
         y1z = a43T
         y2z = a43T 
         x1z = 50.0
         x2z = 150.0
      elseif ( vs30 .le. 250.0 ) then
         y1z = a43T
         y2z = a44T 
         x1z = 150.0
         x2z = 250.0
      elseif ( vs30 .le. 400.0 ) then
         y1z = a44T
         y2z = a45T 
         x1z = 250.0
         x2z = 400.0
      elseif ( vs30 .le. 700.0 ) then
         y1z = a45T
         y2z = a46T 
         x1z = 400.0
         x2z = 700.0
      else
         y1z = a46T
         y2z = a46T 
         x1z = 700.0
         x2z = 1000.0
      endif
C     Calculation f10 term and set it equal to zero for Vs=1180m/s (i.e., reference condition)
      if (vs30 .eq. 1180.0) then
          f10 = 0.0
      else
         f10 = ( y1z + (Vs30-x1z)*(y2z-y1z)/(x2z-x1z))*alog( (z1 + 0.01) / (z1_ref+0.01) )
      endif

c     Compute HW taper1 (eq 4.11) 
      if ( dip .lt. 30. ) then
        HW_taper1 = 60./ 45.
      else
        HW_taper1 = (90.-dip)/45.
      endif

c     Compute HW taper2 (eq. 4.12)
      hw_a2 = 0.2
      if( mag .gt. 6.5 ) then
        HW_taper2 = 1. + hw_a2 * (mag-6.5) 
      elseif ( mag .gt. 5.5 ) then
        HW_taper2 = 1. + HW_a2 * (mag-6.5) - (1.0 - HW_a2)*(mag-6.5)**2
      else
        HW_taper2 = 0.
      endif

c     Compute HW taper 3 (eq. 4.13)
C	  April 11, correction by ronnie for HW_taper3 when Rx.gt.R2
      h1 = 0.25
      h2 = 1.5
      h3 = -0.75
      R1 = fltWidth * cos(dip*3.1415926/180.)
      R2 = 3.*R1
      if ( Rx .le. R1 ) then
        HW_taper3 = h1 + h2*(Rx/R1) + h3*(Rx/R1)**2
      elseif ( Rx . lt. R2 ) then
        HW_taper3 = 1. - (Rx-R1)/(R2-R1)
      else
        HW_taper3 = 0.
      endif 

c     Compute HW taper 4 (eq 4.14)
      if ( ZTOR .lt. 10. ) then
        HW_taper4 = 1. - (ZTOR**2) / 100.
      else
        HW_taper4 = 0.
      endif
      
c     Compute HW taper 5 (eq. 13)  **** Ry0 version, not used here ***     
c      Ry1 = Rx * tan(20.*3.1415926/180.)
c      if ( Ry0 .lt. Ry1 ) then
c        HW_taper5 = 1.
c      elseif ( Ry0-Ry1 .lt. 5. ) then
c        HW_taper5 = 1. - (Ry0-Ry1) / 5.
c      else
c        HW_taper5 = 0.
c      endif

c     Compute HW taper 5 (eq. 4.15b)  **** No Ry0 version ***     
      if (Rjb .eq. 0. ) then
        HW_taper5 = 1. 
      elseif ( Rjb .lt. 30. ) then
        HW_taper5 = 1 - Rjb/30.
      else
        HW_taper5 = 0.
      endif

c     Hanging wall Model (eq 4.10)
      if ( HWFlag .eq. 1 ) then
        f4 = a13T * HW_taper1 * HW_taper2 * HW_taper3 * HW_taper4 * HW_taper5
      else
        f4 = 0.
      endif

C     Add aftershock factor (eq 4.21)
      if (msasflag .eq. 1) then
         if (CRjb .gt. 15.0) then
             f11 = 0.0
         elseif (CRjb .le. 5.0) then
             f11 = a14T
         else
             f11 = a14T * ( 1.0 - (CRjb - 5.0) /10.0) 
         endif
      elseif (msasflag .eq. 0) then
         f11 = 0.0
      endif 

C     Now apply the regional attenuation differences (eq 4.22)
C     Global No Change
      if (regionflag .eq. 0) then
         freg = 0.0
C     Taiwan
      elseif (regionflag .eq. 1) then
         f12 = a31T * alog(Vs30star/VlinT) 
         freg = f12 + a25T*Rrup 
C     China
      elseif (regionflag .eq. 2) then
         freg = a28T*Rrup 
C     Japan
      elseif (regionflag .eq. 3) then
         if (vs30 .lt. 150.0) then
             y1 = a36T
             y2 = a36T
             x1 = 50.0
             x2 = 150.0
         elseif (vs30 .lt. 250.0) then
             y1 = a36T
             y2 = a37T
             x1 = 150.0
             x2 = 250.0
         elseif (vs30 .lt. 350.0) then
             y1 = a37T
             y2 = a38T
             x1 = 250.0
             x2 = 350.0
         elseif (vs30 .lt. 450.0) then
             y1 = a38T
             y2 = a39T
             x1 = 350.0
             x2 = 450.0
         elseif (vs30 .lt. 600.0) then
             y1 = a39T
             y2 = a40T
             x1 = 450.0
             x2 = 600.0
         elseif (vs30 .lt. 850.0) then
             y1 = a40T
             y2 = a41T
             x1 = 600.0
             x2 = 850.0
         elseif (vs30 .lt. 1150.0) then
             y1 = a41T
             y2 = a42T
             x1 = 850.0
             x2 = 1150.0
         else
             y1 = a42T
             y2 = a42T
             x1 = 1150.0
             x2 = 3000.0
         endif
         f13 = y1 + (y2-y1)/(x2-x1) * (vs30-x1)
         freg = f13 + a29T*Rrup 
      endif

C     Set the Sigma Values
      if (regionflag .ne. 3)  then
c     Compute within-event term, phiA, at the surface for linear site response (eq 7.1)
        if (mag .lt. 4.0) then
           phiA_est = s1estT
        elseif (mag .le. 6.0) then
           phiA_est = s1estT + ((s2estT-s1estT)/2.0)*(mag-4.0)
        else
           phiA_est = s2estT
        endif

c     Compute within-event term, phiA, for known Vs30
        if (mag .lt. 4.0) then
           phiA_msr = s1msrT
        elseif (mag .le. 6.0) then
           phiA_msr = s1msrT + ((s2msrT-s1msrT)/2.0)*(mag-4.0)
        else
           phiA_msr = s2msrT
        endif

C     choose phiA by Vs30 class
        if (vs30_class .eq. 0 ) then
	     phiA = phiA_est
        elseif (vs30_class .eq. 1) then
	     phiA = phiA_msr
        else
	     stop 99
        endif

C     Set Sigma values for Japan Region
      else

C calculate phi_A for Japan (eq. 7.3)
        if (Rrup .lt. 30) then
           phiA = s5T        
        elseif (Rrup .le. 80) then
           phiA = s5T + (s6T-s5T)/50*(Rrup-30)
        else
           phiA = s6T
        endif
      endif
	  
c     Compute between-event term, tau (eq. 7.2)
      if (mag .lt. 5.0) then
         tauA = s3T
      elseif (mag .le. 7.0) then
         tauA = s3T + ((s4T-s3T)/2.0)*(mag-5.0)
      else
         tauA = s4T
      endif
      tauB = tauA

c     Compute phiB, within-event term with site amp variablity removed (eq. 7.7)
      sigAmp = 0.4
      phiB = sqrt( phiA**2 - sigAmp**2)
      
c     Compute parital derivative of alog(soil amp) w.r.t. alog(Sa1180) (eq. 7.10)
      if ( vs30 .ge. vLinT) then
        dAmp_dSa1180 = 0.
      else
        dAmp_dSa1180 = bT*Sa1180 * ( -1. / (Sa1180+cT) 
     1              + 1./ (Sa1180 + cT*(vs30/vLinT)**(n)) )
      endif

C     Compute phi, with non-linear effects (eq. 7.8)
      phi = sqrt( phiB**2 * (1. + dAmp_dSa1180)**2 + sigAmp**2 )

C     Compute tau, with non-linear effects (eq. 7.9)
      tau = tauB * (1. + dAmp_dSa1180)
      
c     Compute median ground motion (eq. 1)
      f9 = 0.0
      lnSa = f1 + f4 + f5 + f6 + f7 + f8 + f9 + f10 + f11 + freg 

      return
      end
 
 
